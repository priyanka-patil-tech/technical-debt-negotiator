<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ML Tech Debt Negotiator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet"/>
<style>
:root {
  --black:#0a0a0a; --ink:#111318; --panel:#161b22; --border:#21262d;
  --muted:#30363d; --dim:#6e7681; --text:#e6edf3; --soft:#c9d1d9;
  --red:#ff4757; --amber:#ffa502; --green:#2ed573; --blue:#1e90ff; --accent:#ff6b35;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{
  background:var(--black);color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:13px;line-height:1.5;
}
body::before{
  content:'';position:fixed;inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,.01) 2px,rgba(255,255,255,.01) 4px);
  pointer-events:none;z-index:9999;
}

/* â”€â”€ Shell â”€â”€ */
.shell{display:flex;flex-direction:column;height:100vh;overflow:hidden;}
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 24px;border-bottom:1px solid var(--border);
  background:var(--ink);flex-shrink:0;
}
.logo{display:flex;align-items:center;gap:10px;}
.logo-mark{width:28px;height:28px;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:10px;color:var(--accent);}
.logo-text{font-family:'DM Serif Display',serif;font-size:16px;}
.logo-text span{color:var(--accent);font-style:italic;}
.badge{font-family:'Space Mono',monospace;font-size:9px;padding:2px 8px;border:1px solid;border-radius:2px;}
.badge-live{color:var(--green);border-color:var(--green);}
.badge-warn{color:var(--amber);border-color:var(--amber);}
.badge-info{color:var(--blue);border-color:var(--blue);}

/* â”€â”€ Body Layout: Main + Log panel â”€â”€ */
.body-layout{display:flex;flex:1;overflow:hidden;}
.main-area{flex:1;overflow-y:auto;padding:14px 20px;display:flex;flex-direction:column;gap:10px;}
.log-panel{
  width:300px;flex-shrink:0;border-left:1px solid var(--border);
  background:var(--ink);display:flex;flex-direction:column;
}
.log-panel-header{
  padding:10px 14px;border-bottom:1px solid var(--border);
  font-family:'Space Mono',monospace;font-size:9px;color:var(--dim);
  letter-spacing:.1em;text-transform:uppercase;display:flex;justify-content:space-between;align-items:center;
}
.log-panel-body{flex:1;overflow-y:auto;padding:10px 14px;}
.log-line{font-family:'Space Mono',monospace;font-size:10px;line-height:1.8;}
.log-ok{color:var(--green);}
.log-info{color:var(--blue);}
.log-warn{color:var(--amber);}
.log-error{color:var(--red);}
.log-dim{color:var(--dim);}

/* â”€â”€ Cards â”€â”€ */
.card{background:var(--panel);border:1px solid var(--border);}
.card-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.card-title{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--soft);}
.card-body{padding:16px;}

/* â”€â”€ Buttons â”€â”€ */
.btn{
  padding:9px 20px;cursor:pointer;border:none;
  font-family:'Space Mono',monospace;font-size:11px;
  letter-spacing:.06em;text-transform:uppercase;
  transition:all .2s;display:inline-flex;align-items:center;gap:8px;
}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover:not(:disabled){background:#ff8050;transform:translateY(-1px);}
.btn-primary:disabled{background:var(--muted);cursor:not-allowed;}
.btn-secondary{background:var(--panel);color:var(--text);border:1px solid var(--border);}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
.btn-success{background:var(--green);color:#000;}
.btn-success:hover{filter:brightness(1.1);transform:translateY(-1px);}
.btn-blue{background:var(--blue);color:#fff;}
.btn-blue:hover{filter:brightness(1.1);transform:translateY(-1px);}
.btn-block{width:100%;justify-content:center;}

/* â”€â”€ JIRA cards â”€â”€ */
.jira-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.jira-card{
  padding:12px 14px;border:1px solid var(--border);border-top:3px solid var(--muted);
  background:var(--panel);cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:6px;
}
.jira-card:hover{border-top-color:var(--accent);background:rgba(255,107,53,.06);}
.jira-card.selected{border-top-color:var(--accent);background:rgba(255,107,53,.1);}
.jira-card.priority-critical{border-top-color:var(--red);}
.jira-card.priority-high{border-top-color:var(--amber);}
.jira-card.priority-medium{border-top-color:var(--blue);}
.jira-card.selected{border-top-color:var(--accent)!important;}
.jira-card:hover{border-top-color:var(--accent)!important;}
.jira-key{font-family:'Space Mono',monospace;font-size:10px;color:var(--accent);}
.jira-title{font-size:12px;color:var(--soft);line-height:1.5;flex:1;}
.jira-priority{font-family:'Space Mono',monospace;font-size:9px;padding:1px 6px;border:1px solid;}
.priority-critical{color:var(--red);border-color:var(--red);}
.priority-high{color:var(--amber);border-color:var(--amber);}
.priority-medium{color:var(--blue);border-color:var(--blue);}

/* â”€â”€ Debt items with checkbox â”€â”€ */
.debt-row{
  display:flex;align-items:flex-start;gap:10px;
  padding:10px 14px;border-left:3px solid var(--muted);
  background:rgba(255,255,255,.025);margin-bottom:6px;
  transition:all .2s;
}
.debt-row.critical{border-left-color:var(--red);}
.debt-row.high{border-left-color:var(--amber);}
.debt-row.medium{border-left-color:var(--blue);}
.debt-checkbox{width:14px;height:14px;cursor:pointer;margin-top:2px;accent-color:var(--accent);flex-shrink:0;}
.debt-info{flex:1;}
.debt-type-tag{font-family:'Space Mono',monospace;font-size:9px;font-weight:700;text-transform:uppercase;}
.debt-type-tag.critical{color:var(--red);}
.debt-type-tag.high{color:var(--amber);}
.debt-type-tag.medium{color:var(--blue);}
.debt-desc{font-size:12px;color:var(--soft);margin:2px 0;}
.debt-loc{font-family:'Space Mono',monospace;font-size:9px;color:var(--dim);}
.debt-cost-tag{text-align:right;flex-shrink:0;}
.debt-cost-num{font-family:'Space Mono',monospace;font-size:12px;color:var(--red);}
.debt-effort{font-family:'Space Mono',monospace;font-size:9px;color:var(--dim);margin-top:2px;}

/* â”€â”€ Repo display â”€â”€ */
.repo-box{
  background:var(--ink);border:1px solid var(--border);
  padding:10px 14px;display:flex;align-items:center;gap:10px;
  font-family:'Space Mono',monospace;font-size:12px;
}
.repo-icon{font-size:16px;}
.repo-name{color:var(--accent);}

/* â”€â”€ KPI boxes â”€â”€ */
.kpi-grid{display:grid;gap:12px;}
.kpi-box{background:var(--panel);border:1px solid var(--border);padding:14px;}
.kpi-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:4px;}
.kpi-val{font-family:'DM Serif Display',serif;font-size:28px;line-height:1.1;}
.kpi-val.red{color:var(--red);}
.kpi-val.green{color:var(--green);}
.kpi-val.amber{color:var(--amber);}
.kpi-val.blue{color:var(--blue);}
.kpi-sub{font-size:10px;color:var(--dim);margin-top:2px;}

/* â”€â”€ Negotiation cards â”€â”€ */
.nego-grid{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:start;}
.nego-vs{padding-top:50px;font-family:'DM Serif Display',serif;font-size:24px;color:var(--muted);text-align:center;}
.nego-card{border:2px solid;padding:16px;}
.nego-card.opt-a{border-color:var(--red);}
.nego-card.opt-b{border-color:var(--green);}
.nego-card-label{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:.15em;text-transform:uppercase;margin-bottom:4px;}
.nego-card-label.a{color:var(--red);}
.nego-card-label.b{color:var(--green);}
.nego-card-title{font-family:'DM Serif Display',serif;font-size:17px;margin-bottom:12px;}
.nego-stat{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:11px;}
.nego-stat:last-child{border-bottom:none;}
.nego-stat-label{color:var(--dim);}
.nego-stat-val{font-family:'Space Mono',monospace;}

/* â”€â”€ Final dashboard â”€â”€ */
.final-kpi-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:1px;background:var(--border);}
.final-kpi{background:var(--panel);padding:14px 16px;}

/* â”€â”€ Recommendation box â”€â”€ */
.rec-box{padding:16px 20px;border:1px solid rgba(46,213,115,.3);background:rgba(46,213,115,.06);}
.rec-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--green);letter-spacing:.12em;margin-bottom:6px;}
.rec-title{font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:8px;}
.rec-body{font-size:12px;color:var(--soft);line-height:1.7;}

/* â”€â”€ Section header â”€â”€ */
.section-title{font-family:'DM Serif Display',serif;font-size:22px;margin-bottom:4px;}
.section-sub{font-size:11px;color:var(--dim);margin-bottom:12px;}

/* â”€â”€ two-col â”€â”€ */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}

/* â”€â”€ Inline pills â”€â”€ */
.pill{font-family:'Space Mono',monospace;font-size:9px;padding:2px 7px;letter-spacing:.06em;text-transform:uppercase;}
.pill-red{background:rgba(255,71,87,.15);color:var(--red);border:1px solid rgba(255,71,87,.3);}
.pill-amber{background:rgba(255,165,2,.15);color:var(--amber);border:1px solid rgba(255,165,2,.3);}
.pill-blue{background:rgba(30,144,255,.15);color:var(--blue);border:1px solid rgba(30,144,255,.3);}
.pill-green{background:rgba(46,213,115,.15);color:var(--green);border:1px solid rgba(46,213,115,.3);}

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.fade-in{animation:fadeIn .35s ease both;}
.spin{display:inline-block;animation:spin 1s linear infinite;}
.pulse{animation:pulse 1.5s ease infinite;}

/* â”€â”€ Progress â”€â”€ */
.prog-bar{height:4px;background:var(--muted);}
.prog-fill{height:100%;background:var(--accent);transition:width .4s ease;}

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--ink);}
::-webkit-scrollbar-thumb{background:var(--muted);}

/* â”€â”€ Agent flow steps â”€â”€ */
.agent-steps{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:10px 0;}
.agent-step{font-family:'Space Mono',monospace;font-size:9px;padding:4px 10px;border:1px solid var(--border);color:var(--dim);}
.agent-step.active{border-color:var(--amber);color:var(--amber);background:rgba(255,165,2,.08);}
.agent-step.done{border-color:var(--green);color:var(--green);background:rgba(46,213,115,.06);}
.agent-step-arrow{color:var(--muted);font-size:10px;}

/* â”€â”€ input â”€â”€ */
.input-field{background:var(--ink);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-size:12px;font-family:'Space Mono',monospace;outline:none;width:100%;}
.input-field:focus{border-color:var(--accent);}
.input-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;display:block;margin-bottom:4px;}

/* â”€â”€ Phase transition â”€â”€ */
.phase-header{
  display:flex;align-items:center;gap:12px;padding:10px 14px;
  background:var(--ink);border:1px solid var(--border);border-left:3px solid var(--accent);
  margin-bottom:10px;
}
.phase-icon{font-size:20px;}
.phase-title{font-family:'DM Serif Display',serif;font-size:18px;}
.phase-sub{font-size:11px;color:var(--dim);}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback} = React;

const fmt = n => '$'+Math.round(n).toLocaleString();
const wait = ms => new Promise(r => setTimeout(r, ms));

// â”€â”€ ML-focused JIRA data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const JIRA_ITEMS = [
  { key:'ML-1401', title:'Fraud alerts take 5+ minutes â€” customers want instant notifications', priority:'critical', repo:'ml-inference-engine', summary:'Blocked: the system processes all transactions in a nightly batch instead of checking each one live', points:13 },
  { key:'ML-1402', title:'Our fraud model is 15 months out of date â€” it is missing new scam patterns', priority:'critical', repo:'training-orchestrator', summary:'Blocked: no automated pipeline to retrain the model; accuracy has dropped from 94% to 67% as fraudsters adapted', points:21 },
  { key:'ML-1403', title:'Predictions in testing look great but break in production â€” data mismatch', priority:'high', repo:'feature-store-service', summary:'Blocked: the data the model trains on is calculated differently from the data it sees at runtime, causing an 8% accuracy loss', points:8 },
  { key:'ML-1404', title:'Regulators are asking why we flagged a transaction â€” we cannot explain it', priority:'high', repo:'ml-inference-engine', summary:'Blocked: the model is a black box with no audit trail; compliance approval is on hold until we can show our reasoning', points:13 },
  { key:'ML-1405', title:'Testing a new fraud detection idea takes 3 weeks â€” needs to take hours', priority:'medium', repo:'experiment-platform', summary:'Blocked: there is no framework to run two models side-by-side; every experiment requires a full manual deploy cycle', points:5 },
];

// â”€â”€ Repository data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const REPO_DATA = {
  'ml-inference-engine': {
    name: 'ml-inference-engine',
    description: 'Core ML model serving & prediction API',
    language: 'Python / FastAPI',
    files: 147, stars: 89, lastCommit: '3 days ago',
    debts: [
      { id:'D1', severity:'critical', type:'Batch-Only Pipeline', description:'Every fraud check joins a queue and is processed in bulk every 5 minutes. There is no way to check a single transaction the moment it happens â€” making real-time alerts impossible with the current setup.', annual_cost:520000, fix_weeks:6 },
      { id:'D2', severity:'critical', type:'No Safe Rollback', description:'If a bad model update goes live, fixing it means engineers manually swapping files on the server â€” a process that takes 4 hours and causes a full outage. There is no one-click rollback. Three incidents in the last 6 months cost the business $120K.', annual_cost:380000, fix_weeks:4 },
      { id:'D3', severity:'high', type:'One File Does Everything', description:'A single code file is responsible for 6,200 lines of logic covering loading models, cleaning data, running predictions, caching results, and monitoring â€” all tangled together. Nobody fully understands it, so any change carries high risk of breaking something else.', annual_cost:210000, fix_weeks:5 },
      { id:'D4', severity:'high', type:'Hardcoded Business Rules', description:'47 data transformation rules are scattered across 12 different files with no documentation. Changing one rule unpredictably breaks three others. Adding a new data source or updating a rule requires a full investigation before touching anything.', annual_cost:175000, fix_weeks:3 },
      { id:'D5', severity:'medium', type:'No Performance Monitoring', description:'There are no automatic checks on how well the fraud model is performing day-to-day. When accuracy drops, customers notice fraudulent transactions slipping through before the engineering team does. Average time to detect a model failure is 11 days.', annual_cost:95000, fix_weeks:2 },
    ]
  },
  'training-orchestrator': {
    name: 'training-orchestrator',
    description: 'ML training pipeline & experiment tracking',
    language: 'Python / Airflow',
    files: 89, stars: 34, lastCommit: '12 days ago',
    debts: [
      { id:'D6', severity:'critical', type:'15-Month-Old Training Data', description:'The fraud model has not been retrained in 15 months. It has never seen any scam patterns that emerged in the past year. As a result, detection accuracy has fallen from 94% to 67% â€” meaning 1 in 3 fraud cases is now being missed.', annual_cost:440000, fix_weeks:5 },
      { id:'D7', severity:'high', type:'Experiments Tracked in Spreadsheets', description:'There is no system to record what data, settings, or code produced each model. Past results cannot be reproduced. If regulators ask which inputs led to a decision, the team cannot answer. Every new experiment starts from scratch with no institutional memory.', annual_cost:185000, fix_weeks:3 },
      { id:'D8', severity:'medium', type:'Training Limited to One Machine', description:'The model training process is locked to a single server and cannot be split across multiple machines. Training a large model takes up to 72 hours, limiting the team to one experiment per week and blocking engineers from trying new approaches quickly.', annual_cost:120000, fix_weeks:4 },
    ]
  },
  'feature-store-service': {
    name: 'feature-store-service',
    description: 'Centralized ML feature storage and serving',
    language: 'Python / Redis / Spark',
    files: 62, stars: 21, lastCommit: '8 days ago',
    debts: [
      { id:'D9', severity:'high', type:'Test Results Don\'t Match Production', description:'The data the model is trained and tested on is calculated differently from the data it sees when running live. This mismatch causes an 8% accuracy gap between what the team sees in testing and what actually happens in production â€” giving false confidence before launch.', annual_cost:290000, fix_weeks:5 },
      { id:'D10', severity:'medium', type:'No Audit Trail for Model Inputs', description:'Nobody tracks which data inputs each model version relies on. When something changes upstream, the impact on models is invisible until a failure occurs in production. The compliance team cannot produce an audit trail, which is currently blocking regulatory approval.', annual_cost:140000, fix_weeks:2 },
    ]
  },
};

// All debts flat
const ALL_DEBTS = Object.values(REPO_DATA).flatMap(r => r.debts);

// â”€â”€ Log panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LogPanel({logs}) {
  const [open, setOpen] = useState(false);
  const ref = useRef(null);
  useEffect(()=>{ if(ref.current) ref.current.scrollTop = ref.current.scrollHeight; },[logs]);
  return (
    <div className="log-panel" style={{width: open ? 300 : 36, transition:'width .25s ease', overflow:'hidden'}}>
      <div className="log-panel-header" style={{cursor:'pointer', justifyContent:'center', padding:'10px 8px'}}
        onClick={()=>setOpen(o=>!o)}>
        {open ? (
          <>
            <span style={{flex:1}}>Agent Logs</span>
            <span className="badge badge-live" style={{marginRight:6}}>{logs.length}</span>
            <span style={{fontSize:11, color:'var(--dim)'}}>âœ•</span>
          </>
        ) : (
          <span title="Show agent logs" style={{fontSize:14, writingMode:'vertical-rl', transform:'rotate(180deg)', color:'var(--dim)', letterSpacing:'.08em', fontFamily:"'Space Mono',monospace", fontSize:'9px', textTransform:'uppercase'}}>
            Logs {logs.length > 0 ? `(${logs.length})` : ''}
          </span>
        )}
      </div>
      {open && (
        <div className="log-panel-body" ref={ref}>
          {logs.length === 0 && <div className="log-line log-dim">Waiting for activityâ€¦</div>}
          {logs.map((l,i)=>(
            <div key={i} className={`log-line log-${l.type}`}>{l.msg}</div>
          ))}
        </div>
      )}
    </div>
  );
}

// â”€â”€ Phase 1: JIRA Backlog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const JIRA_PROJECT = {
  name: 'Fraud Detection ML Platform',
  key: 'ML',
  id: 'ML-1401',
  backlogUrl: 'https://pnp16.atlassian.net/jira/software/projects/ML/boards/backlog',
  boardUrl:   'https://pnp16.atlassian.net/jira/software/projects/ML/boards',
};

function jiraIssueUrl(key) {
  return `https://pnp16.atlassian.net/jira/software/projects/ML/issues/${key}`;
}

function PhaseJira({onSelect, selectedItem, logs, running, onLoad}) {
  const [jiraUrl, setJiraUrl] = React.useState(JIRA_PROJECT.backlogUrl);

  return (
    <div className="fade-in">
      <div className="phase-header" style={{flexDirection:'column',alignItems:'stretch',gap:14,padding:'18px 20px'}}>

        {/* Top row: icon + title + button */}
        <div style={{display:'flex',alignItems:'center',gap:12}}>
          <div className="phase-icon" style={{fontSize:24}}>ğŸ«</div>
          <div style={{flex:1}}>
            <div className="phase-title" style={{fontSize:20}}>{JIRA_PROJECT.id} â€” {JIRA_PROJECT.name}</div>
            <div className="phase-sub" style={{marginTop:3}}>
              Roadmap backlog â€” tech debt blockers flagged by engineering. Paste your own JIRA backlog URL below, then click Load.
            </div>
          </div>
          {!logs.length && (
            <button className="btn btn-primary" style={{flexShrink:0}} onClick={onLoad} disabled={running}>
              {running ? <><span className="spin">âŸ³</span> Loadingâ€¦</> : 'â–¶ Load JIRA Backlog'}
            </button>
          )}
        </div>

        {/* JIRA URL input row */}
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <span style={{fontFamily:"'Space Mono',monospace",fontSize:'10px',color:'var(--dim)',whiteSpace:'nowrap',letterSpacing:'.06em'}}>
            JIRA BACKLOG URL
          </span>
          <div style={{flex:1,position:'relative'}}>
            <input
              className="input-field"
              value={jiraUrl}
              onChange={e=>setJiraUrl(e.target.value)}
              spellCheck={false}
              style={{paddingLeft:28,fontSize:'11px',letterSpacing:'.02em'}}
            />
            <span style={{position:'absolute',left:9,top:'50%',transform:'translateY(-50%)',fontSize:'11px',pointerEvents:'none'}}>ğŸ”—</span>
          </div>
          <a href={jiraUrl} target="_blank" rel="noopener noreferrer"
            style={{fontFamily:"'Space Mono',monospace",fontSize:'10px',color:'var(--blue)',textDecoration:'none',
                    padding:'7px 12px',border:'1px solid rgba(30,144,255,.35)',whiteSpace:'nowrap',flexShrink:0}}>
            Open â†—
          </a>
        </div>

      </div>

      {logs.length > 0 && (
        <div className="fade-in">
          <div style={{marginBottom:8,fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--dim)',letterSpacing:'.1em',textTransform:'uppercase'}}>
            {JIRA_ITEMS.length} blocker items Â· Click a ticket to trace its repository
          </div>
          <div className="jira-grid">
            {JIRA_ITEMS.map(item=>(
              <div key={item.key}
                className={`jira-card priority-${item.priority} ${selectedItem?.key===item.key?'selected':''}`}
                onClick={()=>onSelect(item)}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                  <span className="jira-key">{item.key}</span>
                  <span className={`jira-priority priority-${item.priority}`}>{item.priority}</span>
                </div>
                <div className="jira-title">{item.title}</div>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:'auto'}}>
                  <a href={jiraIssueUrl(item.key)} target="_blank" rel="noopener noreferrer"
                    style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--blue)',textDecoration:'none'}}
                    onClick={e=>e.stopPropagation()}>
                    ğŸ”— Open ticket
                  </a>
                  <span style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--dim)'}}>{item.points}pts</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€ Phase 2: Repository â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseRepo({selectedJira, repoName, onScan, scanning, scanned}) {
  const repo = REPO_DATA[repoName];
  return (
    <div className="fade-in">
      <div className="card" style={{marginBottom:14}}>
        <div className="card-head" style={{padding:'14px 18px'}}>
          <span style={{fontFamily:"'DM Serif Display',serif",fontSize:20,color:'var(--text)',letterSpacing:'.01em'}}>
            ğŸ“ Linked Repository
          </span>
          <span className="badge badge-live" style={{marginLeft:'auto'}}>LOADED</span>
        </div>
        <div className="card-body">
          <div className="repo-box">
            <div className="repo-icon">âš™ï¸</div>
            <div>
              <div className="repo-name">{repoName}</div>
              <div style={{fontSize:'10px',color:'var(--dim)'}}>{repo?.description}</div>
            </div>
            <div style={{marginLeft:'auto',textAlign:'right'}}>
              <div style={{fontFamily:"'Space Mono',monospace",fontSize:'10px',color:'var(--dim)'}}>{repo?.language}</div>
              <div style={{fontFamily:"'Space Mono',monospace",fontSize:'10px',color:'var(--dim)'}}>{repo?.files} files Â· last commit {repo?.lastCommit}</div>
            </div>
          </div>
          <div style={{marginTop:12}}>
            <label className="input-label">Repository URL</label>
            <input className="input-field" readOnly value={`https://github.com/ml-platform/${repoName}`}/>
          </div>
        </div>
      </div>

      {!scanned && (
        <button className="btn btn-primary btn-block" onClick={onScan} disabled={scanning}>
          {scanning ? <><span className="spin">âŸ³</span> Scanningâ€¦</> : 'ğŸ” Scan Repositories'}
        </button>
      )}
    </div>
  );
}

// â”€â”€ Phase 3: Debt Items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseDebt({debts, selected, onToggle, onCalc, calculating, costData}) {
  const total = debts.filter(d=>selected.includes(d.id)).reduce((s,d)=>s+d.annual_cost,0);
  const ref = useRef(null);
  useEffect(()=>{ if(ref.current) ref.current.scrollIntoView({behavior:'smooth', block:'start'}); }, []);
  return (
    <div className="fade-in" ref={ref}>
      <div className="phase-header">
        <div className="phase-icon">ğŸ¤–</div>
        <div>
          <div className="phase-title">Debt Items Detected</div>
          <div className="phase-sub">AI-identified technical debt across linked repositories. Select items to include in cost calculation.</div>
        </div>
        <div style={{marginLeft:'auto',textAlign:'right'}}>
          <div style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--dim)'}}>SELECTED ANNUAL COST</div>
          <div style={{fontFamily:"'DM Serif Display',serif",fontSize:'22px',color:'var(--red)'}}>{fmt(total)}</div>
        </div>
      </div>

      <div style={{maxHeight:'calc(100vh - 380px)',overflowY:'auto',marginBottom:14}}>
        {debts.map(d=>(
          <div key={d.id} className={`debt-row ${d.severity}`}>
            <input type="checkbox" className="debt-checkbox"
              checked={selected.includes(d.id)}
              onChange={()=>onToggle(d.id)}/>
            <div className="debt-info">
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
                <span className={`pill pill-${d.severity==='critical'?'red':d.severity==='high'?'amber':'blue'}`}>{d.severity}</span>
                <span style={{fontFamily:"'Space Mono',monospace",fontSize:'10px',fontWeight:700,color: d.severity==='critical'?'var(--red)':d.severity==='high'?'var(--amber)':'var(--blue)'}}>{d.type}</span>
              </div>
              <div style={{fontSize:'14px',color:'var(--text)',lineHeight:1.6}}>{d.description}</div>
            </div>
            <div className="debt-cost-tag" style={{textAlign:'right',whiteSpace:'nowrap'}}>
              <div className="debt-cost-num">{fmt(d.annual_cost)}/yr</div>
              <div style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--dim)'}}>if left unfixed</div>
              <div style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--green)',marginTop:4}}>{d.fix_weeks}w to fix</div>
            </div>
          </div>
        ))}
      </div>

      {!costData && (
        <button className="btn btn-primary btn-block" onClick={onCalc} disabled={calculating||selected.length===0}>
          {calculating ? <><span className="spin">âŸ³</span> Calculatingâ€¦</> : `ğŸ’° Calculate Effort & Cost (${selected.length} items selected)`}
        </button>
      )}
    </div>
  );
}

// â”€â”€ Phase 4: Cost Preview (Live) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseCost({costData, selectedDebts, allDebts, onNegotiate, negotiating, negotiation}) {
  const ref = useRef(null);
  useEffect(()=>{ if(ref.current) ref.current.scrollIntoView({behavior:'smooth', block:'start'}); }, []);
  return (
    <div className="fade-in" ref={ref}>
      <div className="phase-header">
        <div className="phase-icon">ğŸ’°</div>
        <div>
          <div className="phase-title">What Does Fixing This Actually Cost?</div>
          <div className="phase-sub">Based on the issues selected above â€” how much to fix them, how much they save, and when you break even.</div>
        </div>
      </div>

      <div className="three-col" style={{marginBottom:14}}>
        {[
          {label:'Refactoring Cost',val:fmt(costData.refactoring_cost),cls:'amber',sub:`${costData.effort_weeks}w Ã— 4 engineers`},
          {label:'Annual Savings',val:fmt(costData.annual_savings),cls:'green',sub:'Debt costs eliminated'},
          {label:'Break-Even',val:`Wk ${costData.break_even_weeks}`,cls:'blue',sub:'Then saves forever'},
          {label:'First-Year ROI',val:`${costData.roi_pct}%`,cls:costData.roi_pct>0?'green':'red',sub:'Return on investment'},
          {label:'Critical Issues',val:costData.critical_count,cls:'red',sub:`${costData.total_count} total selected`},
          {label:'Prod Risk (Build Now)',val:'65%',cls:'red',sub:'Regression probability'},
        ].map((k,i)=>(
          <div key={i} className="kpi-box">
            <div className="kpi-label">{k.label}</div>
            <div className={`kpi-val ${k.cls}`}>{k.val}</div>
            <div className="kpi-sub">{k.sub}</div>
          </div>
        ))}
      </div>

      {!negotiation && (
        <button className="btn btn-blue btn-block" onClick={onNegotiate} disabled={negotiating}>
          {negotiating ? <><span className="spin">âŸ³</span> Running Negotiation Agentâ€¦</> : 'âš–ï¸ Run Negotiations'}
        </button>
      )}
    </div>
  );
}

// â”€â”€ Phase 5: Negotiation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseNego({negotiation, costData, onDashboard}) {
  return (
    <div className="fade-in">
      <div className="phase-header">
        <div className="phase-icon">âš–ï¸</div>
        <div>
          <div className="phase-title">Negotiation Agent â€” Refactor vs Build</div>
          <div className="phase-sub">AI agent cross-references debt impact against JIRA feature blockers and models both paths.</div>
        </div>
      </div>

      <div className="nego-grid" style={{marginBottom:14}}>
        <div className="nego-card opt-a">
          <div className="nego-card-label a">OPTION A</div>
          <div className="nego-card-title">Build Features Now</div>
          {[
            ['Timeline','16 weeks'],['Success Rate','35%'],['Risk','HIGH'],
            ['Regression Risk','65%'],['Ongoing Cost','$23K/mo'],['Break-Even','Never (costs grow)'],
          ].map(([l,v],i)=>(
            <div key={i} className="nego-stat">
              <span className="nego-stat-label">{l}</span>
              <span className="nego-stat-val" style={{color:i===1||i===2?'var(--red)':undefined}}>{v}</span>
            </div>
          ))}
          <div style={{marginTop:12,fontSize:'11px',color:'var(--red)',lineHeight:1.9}}>
            <div style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--dim)',marginBottom:6,letterSpacing:'.08em'}}>WHAT HAPPENS NEXT</div>
            <div>âœ— Fraud alerts stay delayed 5+ min â€” batch pipeline blocks real-time</div>
            <div>âœ— Model accuracy stuck at 67% and falling every week</div>
            <div>âœ— Touching any data rule risks silent bugs across 12 files</div>
            <div>âœ— Regulators reject compliance dashboard â€” decisions unexplainable</div>
            <div>âœ— Bad deploys still mean 4h outage â€” no rollback exists</div>
            <div>âœ— {fmt(costData.annual_savings)}/yr in debt costs keep compounding</div>
          </div>
        </div>

        <div className="nego-vs">vs</div>

        <div className="nego-card opt-b">
          <div className="nego-card-label b">OPTION B â€” RECOMMENDED</div>
          <div className="nego-card-title">Refactor First, Then Build</div>
          {[
            ['Refactor','12 weeks'],['Feature Build','4 weeks'],['Total','16 weeks'],
            ['Success Rate','92%'],['Risk','LOW'],['Break-Even',`Week ${costData.break_even_weeks}`],
          ].map(([l,v],i)=>(
            <div key={i} className="nego-stat">
              <span className="nego-stat-label">{l}</span>
              <span className="nego-stat-val" style={{color:i===3||i===4?'var(--green)':undefined}}>{v}</span>
            </div>
          ))}
          <div style={{marginTop:12,fontSize:'11px',color:'var(--green)',lineHeight:1.9}}>
            <div style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--dim)',marginBottom:6,letterSpacing:'.08em'}}>WHAT YOU UNLOCK</div>
            <div>âœ“ Fraud alerts under 1 second â€” real-time pipeline replaces batch</div>
            <div>âœ“ Model accuracy back to 94%+ with automated weekly retraining</div>
            <div>âœ“ Data rules safe to change â€” documented, centralised, tested</div>
            <div>âœ“ Every decision explainable â€” ML-1404 compliance unblocked</div>
            <div>âœ“ One-click rollback â€” no more 4h outages from bad deploys</div>
            <div>âœ“ {fmt(costData.annual_savings)}/yr saved â€” all 5 features ship cleanly</div>
          </div>
        </div>
      </div>

      <div className="rec-box" style={{marginBottom:14}}>
        <div className="rec-label">âœ“ AGENT RECOMMENDATION</div>
        <div className="rec-title">Refactor First â€” Then Ship All 5 Features</div>
        <div className="rec-body" style={{marginBottom:16}}>{negotiation.reason}</div>

        {/* Tradeoff grid */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:1,background:'rgba(255,255,255,.06)',marginBottom:14}}>
          {[
            {label:'Success rate gap',val:'35% â†’ 92%',note:'+57 points in your favour',cls:'green'},
            {label:'Time to working feature',val:`${costData.effort_weeks+4}w vs 16w+`,note:`Option B: ${costData.effort_weeks}w refactor + 4w build, ships once. Option A: 8w build + 8w+ rework after the 65% regression hits.`,cls:'blue'},
            {label:'If Option A fails',val:'Refactor anyway',note:`Both paths combined = ${costData.effort_weeks+16}w & double the cost`,cls:'red'},
            {label:'First-year net gain',val:fmt(costData.annual_savings - costData.refactoring_cost),note:`after paying back the ${fmt(costData.refactoring_cost)} investment`,cls:'green'},
          ].map((t,i)=>(
            <div key={i} style={{padding:'10px 14px',background:'var(--ink)'}}>
              <div style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--dim)',marginBottom:3,letterSpacing:'.06em'}}>{t.label.toUpperCase()}</div>
              <div style={{fontFamily:"'DM Serif Display',serif",fontSize:'15px',color:`var(--${t.cls})`}}>{t.val}</div>
              <div style={{fontSize:'10px',color:'var(--dim)',marginTop:2}}>{t.note}</div>
            </div>
          ))}
        </div>

        {/* Confidence signal */}
        <div style={{padding:'10px 14px',border:'1px solid rgba(46,213,115,.2)',background:'rgba(46,213,115,.04)'}}>
          <div style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--green)',letterSpacing:'.08em',marginBottom:4}}>WHY THIS IS A CLEAR CALL, NOT A CLOSE CALL</div>
          <div style={{fontSize:'11px',color:'var(--soft)',lineHeight:1.7}}>
            The gap between Option A (35%) and Option B (92%) is <strong style={{color:'var(--text)'}}>57 percentage points</strong> â€” well above the 15-point threshold where the choice becomes a judgement call. Option A's 8-week promise is misleading: with a 65% regression rate on this codebase, history shows the real timeline becomes 16 weeks or more once debugging and rollbacks are counted. Option B delivers in <strong style={{color:'var(--text)'}}>{costData.effort_weeks+4} weeks with one predictable schedule</strong> and no hidden rework. The only scenario where Option A wins is if the debt is low-severity and the team is confident the workarounds hold â€” neither is true here.
          </div>
        </div>
      </div>

      <button className="btn btn-success btn-block" onClick={onDashboard}>
        ğŸ“Š View Final Dashboard â†’
      </button>
    </div>
  );
}

// â”€â”€ Phase 6: Final Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseDashboard({costData, negotiation, selectedDebts, allDebts}) {
  const debts = allDebts.filter(d=>selectedDebts.includes(d.id));
  return (
    <div className="fade-in">
      <div className="phase-header" style={{borderLeftColor:'var(--green)'}}>
        <div className="phase-icon">ğŸ“Š</div>
        <div>
          <div className="phase-title">Final Dashboard â€” ML Platform Tech Debt Report</div>
          <div className="phase-sub">Complete analysis ready to share with your PM, CTO, or engineering board.</div>
        </div>
        <span className="badge badge-live" style={{marginLeft:'auto'}}>ANALYSIS COMPLETE</span>
      </div>

      <div className="final-kpi-grid" style={{marginBottom:14}}>
        {[
          {label:'Annual Debt Cost',val:fmt(costData.annual_savings),cls:'red',sub:'eliminated after refactor'},
          {label:'Refactoring Investment',val:fmt(costData.refactoring_cost),cls:'amber',sub:`${costData.effort_weeks} weeks`},
          {label:'Break-Even',val:`Wk ${costData.break_even_weeks}`,cls:'green',sub:'then saves forever'},
          {label:'First-Year ROI',val:`${costData.roi_pct}%`,cls:'green',sub:'return on investment'},
          {label:'Features Unblocked',val:'5/5',cls:'blue',sub:'JIRA ML-1401 â†’ ML-1405'},
        ].map((k,i)=>(
          <div key={i} className="final-kpi">
            <div className="kpi-label">{k.label}</div>
            <div className={`kpi-val ${k.cls}`} style={{fontSize:'22px'}}>{k.val}</div>
            <div className="kpi-sub">{k.sub}</div>
          </div>
        ))}
      </div>

      <div className="rec-box" style={{marginBottom:14}}>
        <div className="rec-label">âœ“ FINAL RECOMMENDATION</div>
        <div className="rec-title">Refactor ML Infrastructure First â€” Ship All 5 Features by Week 16</div>
        <div className="rec-body">
          The ML platform carries <strong style={{color:'var(--red)'}}>{fmt(costData.annual_savings)}/year</strong> in quantified debt costs.
          The monolithic batch pipeline and 15-month-old training data are directly blocking 4 of 5 JIRA features.
          Building on current infrastructure = 65% regression risk + $23K/month compounding.
          Refactoring (12 weeks) enables real-time inference, auto-retraining, and XAI compliance â€” with 92% delivery confidence and break-even at Week {costData.break_even_weeks}.
        </div>
      </div>

      <div style={{marginBottom:14}}>
        <div style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--dim)',letterSpacing:'.1em',textTransform:'uppercase',marginBottom:8}}>
          Selected Debt Items ({debts.length})
        </div>
        {debts.map(d=>(
          <div key={d.id} className={`debt-row ${d.severity}`} style={{marginBottom:4}}>
            <div className="debt-info">
              <div><span className={`debt-type-tag ${d.severity}`}>[{d.type.replace(/_/g,' ').toUpperCase()}]</span> <span className={`pill pill-${d.severity==='critical'?'red':d.severity==='high'?'amber':'blue'}`}>{d.severity}</span></div>
              <div className="debt-desc">{d.description}</div>
            </div>
            <div className="debt-cost-tag">
              <div className="debt-cost-num">{fmt(d.annual_cost)}/yr</div>
              <div className="debt-effort">{d.fix_weeks}w fix</div>
            </div>
          </div>
        ))}
      </div>

      <div style={{padding:'14px 16px',background:'var(--panel)',border:'1px solid var(--border)',display:'flex',alignItems:'center',justifyContent:'space-around',flexWrap:'wrap',gap:16}}>
        {[['ğŸ«','JIRA Fetcher'],['ğŸ“','Repo Scanner'],['ğŸ¤–','Debt Analyzer'],['ğŸ’°','Cost Model'],['âš–ï¸','Negotiator']].map(([icon,label],i)=>(
          <div key={i} style={{textAlign:'center'}}>
            <div style={{fontSize:'24px'}}>{icon}</div>
            <div style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--green)',marginTop:4}}>âœ“ {label}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [logs, setLogs] = useState([]);
  const [phase, setPhase] = useState('jira'); // jira | repo | debt | cost | nego | dashboard

  // Jira
  const [jiraLoading, setJiraLoading] = useState(false);
  const [jiraLoaded, setJiraLoaded] = useState(false);
  const [selectedJira, setSelectedJira] = useState(null);

  // Repo
  const [scanning, setScanning] = useState(false);
  const [scanned, setScanned] = useState(false);

  // Debt
  const [selectedDebts, setSelectedDebts] = useState([]);
  const [calculating, setCalculating] = useState(false);
  const [costData, setCostData] = useState(null);

  // Nego
  const [negotiating, setNegotiating] = useState(false);
  const [negotiation, setNegotiation] = useState(null);

  const addLog = useCallback((msg, type='info') => setLogs(l=>[...l,{msg,type}]), []);

  // Compute cost live based on selected debts
  const computeCost = (ids) => {
    const items = ALL_DEBTS.filter(d=>ids.includes(d.id));
    const annual_savings = items.reduce((s,d)=>s+d.annual_cost,0);
    const effort_weeks = items.reduce((s,d)=>s+d.fix_weeks,0);
    const refactoring_cost = effort_weeks * 4 * 8000; // 4 engineers Ã— $8k/week
    const break_even_weeks = annual_savings > 0 ? Math.ceil(refactoring_cost/(annual_savings/52)) : 0;
    const roi_pct = annual_savings > 0 ? Math.round(((annual_savings-refactoring_cost)/refactoring_cost)*100) : 0;
    const critical_count = items.filter(d=>d.severity==='critical').length;
    return { annual_savings, effort_weeks, refactoring_cost, break_even_weeks, roi_pct, critical_count, total_count:items.length };
  };

  // Load JIRA
  const loadJira = async () => {
    setJiraLoading(true);
    addLog('â–¶ Connecting to JIRA Cloud (ml-platform.atlassian.net)â€¦','info');
    await wait(600);
    addLog('  âœ“ Authenticated via OAuth token','ok');
    await wait(400);
    addLog('  ğŸ” Querying backlog: project=ML AND labels=tech-debt AND priority IN (Critical,High,Medium)','info');
    await wait(700);
    addLog(`  âœ“ Found ${JIRA_ITEMS.length} blocker items linked to tech debt tracker`,'ok');
    JIRA_ITEMS.forEach((item,i)=>{
      setTimeout(()=>addLog(`    ${item.key}: ${item.title} [${item.priority}]`,'dim'),i*120);
    });
    await wait(JIRA_ITEMS.length*120+300);
    addLog('âœ“ JIRA backlog loaded â€” click an item to trace its repository','ok');
    setJiraLoaded(true);
    setJiraLoading(false);
  };

  const selectJira = async (item) => {
    setSelectedJira(item);
    addLog(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,'dim');
    addLog(`â–¶ Tracing ${item.key} â†’ repository dependencyâ€¦`,'info');
    await wait(400);
    addLog(`  âœ“ Repository linked: ${item.repo}`,'ok');
    addLog(`  ğŸ“¦ Cloning metadata for ${item.repo}â€¦`,'info');
    await wait(300);
    addLog(`  âœ“ ${REPO_DATA[item.repo]?.files} files indexed`,'ok');
    setPhase('repo');
    setScanned(false);
    setSelectedDebts([]);
    setCostData(null);
    setNegotiation(null);
  };

  const scanRepo = async () => {
    setScanning(true);
    const repo = REPO_DATA[selectedJira.repo];
    addLog(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,'dim');
    addLog(`â–¶ Scanning ${selectedJira.repo} for tech debtâ€¦`,'info');
    await wait(500);
    addLog(`  ğŸ¤– Claude analyzing ${repo.files} Python filesâ€¦`,'info');
    await wait(800);
    addLog(`  ğŸ” Pattern detection: god classes, batch pipelines, missing registriesâ€¦`,'info');
    await wait(600);
    repo.debts.forEach((d,i)=>{
      setTimeout(()=>addLog(`  âš  ${d.severity.toUpperCase()}: ${d.type} â€” ${fmt(d.annual_cost)}/yr`,d.severity==='critical'?'error':d.severity==='high'?'warn':'info'),i*200);
    });
    await wait(repo.debts.length*200+400);
    addLog(`âœ“ Found ${repo.debts.length} debt items (${fmt(repo.debts.reduce((s,d)=>s+d.annual_cost,0))}/yr total)`,'ok');
    const ids = repo.debts.map(d=>d.id);
    setSelectedDebts(ids);
    setScanning(false);
    setScanned(true);
    setPhase('debt');
  };

  const toggleDebt = (id) => {
    const next = selectedDebts.includes(id) ? selectedDebts.filter(x=>x!==id) : [...selectedDebts,id];
    setSelectedDebts(next);
    if(costData) setCostData(computeCost(next));
  };

  const calcCost = async () => {
    setCalculating(true);
    addLog(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,'dim');
    addLog(`â–¶ Calculating refactoring economics for ${selectedDebts.length} itemsâ€¦`,'info');
    await wait(500);
    const c = computeCost(selectedDebts);
    addLog(`  âœ“ Total annual cost: ${fmt(c.annual_savings)}`,'ok');
    await wait(400);
    addLog(`  âœ“ Refactoring effort: ${c.effort_weeks}w Ã— 4 engineers Ã— $8K/wk = ${fmt(c.refactoring_cost)}`,'ok');
    await wait(500);
    addLog(`  âœ“ Break-even: Week ${c.break_even_weeks}`,'ok');
    addLog(`  âœ“ First-year ROI: ${c.roi_pct}%`,'ok');
    await wait(300);
    addLog(`âœ“ Cost model ready`,'ok');
    setCostData(c);
    setCalculating(false);
    setPhase('cost');
  };

  const runNegotiation = async () => {
    setNegotiating(true);
    addLog(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,'dim');
    addLog(`â–¶ Running Negotiation Agent (Claude)â€¦`,'info');
    await wait(600);
    addLog(`  âš–ï¸  Cross-referencing ${selectedDebts.length} debt items vs. ${JIRA_ITEMS.length} JIRA ticketsâ€¦`,'info');
    await wait(700);
    const blocked = JIRA_ITEMS.filter(t=>t.repo===selectedJira?.repo||t.priority==='critical');
    addLog(`  ğŸš« ${blocked.length}/${JIRA_ITEMS.length} features blocked or critically slowed by debt`,'warn');
    await wait(500);
    addLog(`  ğŸ¯ Option A (Build Now): 16w, 35% success, $23K/mo ongoing`,'warn');
    await wait(400);
    addLog(`  ğŸ¯ Option B (Refactor First): ${costData.effort_weeks+4}w, 92% success, saves ${fmt(costData.annual_savings)}/yr`,'info');
    await wait(600);
    addLog(`  âœ“ RECOMMENDATION: REFACTOR FIRST`,'ok');
    const nego = {
      recommendation:'refactor_first',
      reason:`${blocked.length} of ${JIRA_ITEMS.length} features are blocked by the ML platform's monolithic batch pipeline and stale training data. Building now carries 65% regression risk plus $23K/month compounding maintenance. Refactoring (${costData.effort_weeks} weeks) enables all features at 92% confidence â€” and breaks even at Week ${costData.break_even_weeks}, generating ${fmt(costData.annual_savings)}/year thereafter.`,
    };
    setNegotiation(nego);
    setNegotiating(false);
    setPhase('nego');
    addLog(`âœ“ Negotiation complete â€” recommendation ready`,'ok');
  };

  const activeRepo = selectedJira ? REPO_DATA[selectedJira.repo] : null;
  const activeDebts = activeRepo ? activeRepo.debts : [];

  const phaseLabel = {
    jira:'JIRA Backlog Scan',repo:'Repository Browser',debt:'Debt Detection',
    cost:'Cost & ROI Analysis',nego:'Negotiation Agent',dashboard:'Final Dashboard',
  }[phase];

  return (
    <div className="shell">
      <div className="topbar">
        <div className="logo">
          <div className="logo-mark">TD</div>
          <div className="logo-text">ML Debt <span>Negotiator</span></div>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          {selectedJira && <span className="badge badge-info">{selectedJira.key}</span>}
          {costData && <span className="badge badge-warn">{fmt(costData.annual_savings)}/YR DEBT</span>}
          {negotiation && <span className="badge badge-live">ANALYSIS COMPLETE</span>}
          <span style={{fontFamily:"'Space Mono',monospace",fontSize:'9px',color:'var(--dim)',textTransform:'uppercase',letterSpacing:'.1em'}}>{phaseLabel}</span>
        </div>
      </div>

      <div className="body-layout">
        <div className="main-area">
          {/* Always show JIRA phase at top */}
          <PhaseJira
            onSelect={selectJira}
            selectedItem={selectedJira}
            logs={logs}
            running={jiraLoading}
            onLoad={loadJira}
          />

          {/* Repo phase */}
          {selectedJira && (phase==='repo'||phase==='debt'||phase==='cost'||phase==='nego'||phase==='dashboard') && (
            <PhaseRepo
              selectedJira={selectedJira}
              repoName={selectedJira.repo}
              onScan={scanRepo}
              scanning={scanning}
              scanned={scanned}
            />
          )}

          {/* Debt phase */}
          {scanned && (phase==='debt'||phase==='cost'||phase==='nego'||phase==='dashboard') && (
            <PhaseDebt
              debts={activeDebts}
              selected={selectedDebts}
              onToggle={toggleDebt}
              onCalc={calcCost}
              calculating={calculating}
              costData={costData}
            />
          )}

          {/* Cost phase */}
          {costData && (phase==='cost'||phase==='nego'||phase==='dashboard') && (
            <PhaseCost
              costData={costData}
              selectedDebts={selectedDebts}
              allDebts={activeDebts}
              onNegotiate={runNegotiation}
              negotiating={negotiating}
              negotiation={negotiation}
            />
          )}

          {/* Nego phase */}
          {negotiation && (phase==='nego'||phase==='dashboard') && (
            <PhaseNego
              negotiation={negotiation}
              costData={costData}
              onDashboard={()=>setPhase('dashboard')}
            />
          )}

          {/* Dashboard */}
          {phase==='dashboard' && (
            <PhaseDashboard
              costData={costData}
              negotiation={negotiation}
              selectedDebts={selectedDebts}
              allDebts={ALL_DEBTS}
            />
          )}
        </div>

        <LogPanel logs={logs}/>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
