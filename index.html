<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tech Debt Negotiator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root {
  /* Core palette â€” deep navy IDE meets JIRA blue */
  --bg:        #0d1117;
  --surface:   #161c26;
  --surface2:  #1c2333;
  --surface3:  #212d40;
  --border:    #2a3547;
  --border2:   #364055;
  --dim:       #5c6e8a;
  --muted:     #8899b0;
  --soft:      #c2cfe0;
  --text:      #e2ecf8;

  /* Accent â€” JIRA-ish cobalt blue shifted to teal-blue */
  --accent:    #3b82f6;
  --accent2:   #60a5fa;
  --accent-bg: rgba(59,130,246,.1);

  /* Semantic colors */
  --red:       #f87171;
  --red-bg:    rgba(248,113,113,.1);
  --red-border:rgba(248,113,113,.3);
  --amber:     #fbbf24;
  --amber-bg:  rgba(251,191,36,.1);
  --amber-border:rgba(251,191,36,.3);
  --green:     #34d399;
  --green-bg:  rgba(52,211,153,.1);
  --green-border:rgba(52,211,153,.3);
  --blue:      #60a5fa;
  --blue-bg:   rgba(96,165,250,.1);
  --blue-border:rgba(96,165,250,.3);

  --radius:    8px;
  --radius-sm: 5px;
  --radius-lg: 12px;

  --shadow:    0 1px 3px rgba(0,0,0,.4), 0 4px 12px rgba(0,0,0,.25);
  --shadow-md: 0 4px 16px rgba(0,0,0,.4), 0 1px 3px rgba(0,0,0,.3);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
  font-size: 13px;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ Shell â”€â”€ */
.shell { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

/* â”€â”€ Topbar â”€â”€ */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; height: 52px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.logo { display: flex; align-items: center; gap: 10px; }
.logo-mark {
  width: 30px; height: 30px;
  background: linear-gradient(135deg, var(--accent), #6366f1);
  border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; font-weight: 700; color: #fff;
  box-shadow: 0 2px 8px rgba(59,130,246,.4);
}
.logo-text { font-size: 15px; font-weight: 600; color: var(--text); letter-spacing: -.2px; }
.logo-text span { color: var(--accent2); }
.badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; font-weight: 500;
  padding: 2px 8px;
  border: 1px solid;
  border-radius: 20px;
  letter-spacing: .04em;
}
.badge-live   { color: var(--green); border-color: var(--green-border); background: var(--green-bg); }
.badge-warn   { color: var(--amber); border-color: var(--amber-border); background: var(--amber-bg); }
.badge-info   { color: var(--blue);  border-color: var(--blue-border);  background: var(--blue-bg); }

/* â”€â”€ Body Layout â”€â”€ */
.body-layout { display: flex; flex: 1; overflow: hidden; }
.main-area {
  flex: 1; overflow-y: auto;
  padding: 16px 20px;
  display: flex; flex-direction: column; gap: 12px;
}
.log-panel {
  width: 300px; flex-shrink: 0;
  border-left: 1px solid var(--border);
  background: var(--surface);
  display: flex; flex-direction: column;
}
.log-panel-header {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; color: var(--dim);
  letter-spacing: .1em; text-transform: uppercase;
  display: flex; justify-content: space-between; align-items: center;
}
.log-panel-body { flex: 1; overflow-y: auto; padding: 10px 14px; }
.log-line { font-family: 'JetBrains Mono', monospace; font-size: 10px; line-height: 1.9; }
.log-ok    { color: var(--green); }
.log-info  { color: var(--blue); }
.log-warn  { color: var(--amber); }
.log-error { color: var(--red); }
.log-dim   { color: var(--dim); }

/* â”€â”€ Cards â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow);
}
.card-head {
  padding: 12px 18px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  background: var(--surface2);
}
.card-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; letter-spacing: .1em; text-transform: uppercase; color: var(--muted);
}
.card-body { padding: 18px; }

/* â”€â”€ Buttons â”€â”€ */
.btn {
  padding: 8px 18px;
  cursor: pointer; border: none;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 12px; font-weight: 600;
  letter-spacing: .01em;
  border-radius: var(--radius);
  transition: all .18s ease;
  display: inline-flex; align-items: center; gap: 7px;
}
.btn-primary {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 2px 8px rgba(59,130,246,.35);
}
.btn-primary:hover:not(:disabled) { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(59,130,246,.45); }
.btn-primary:disabled { background: var(--surface3); color: var(--dim); cursor: not-allowed; box-shadow: none; }
.btn-secondary {
  background: var(--surface2);
  color: var(--soft);
  border: 1px solid var(--border);
}
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }
.btn-success {
  background: var(--green);
  color: #0a1a14;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(52,211,153,.3);
}
.btn-success:hover { filter: brightness(1.08); transform: translateY(-1px); }
.btn-blue { background: var(--blue); color: #0d1831; }
.btn-blue:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn-block { width: 100%; justify-content: center; }

/* â”€â”€ JIRA cards â”€â”€ */
.jira-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.jira-card {
  padding: 14px 16px;
  border: 1px solid var(--border);
  border-left: 4px solid var(--border2);
  border-radius: var(--radius);
  background: var(--surface);
  cursor: pointer;
  transition: all .2s ease;
  display: flex; flex-direction: column; gap: 8px;
  box-shadow: var(--shadow);
}
.jira-card:hover { border-left-color: var(--accent); background: var(--surface2); transform: translateY(-1px); box-shadow: var(--shadow-md); }
.jira-card.selected { border-left-color: var(--accent) !important; background: color-mix(in srgb, var(--accent) 8%, var(--surface)); box-shadow: 0 0 0 1px var(--accent), var(--shadow-md); }
.jira-card.priority-critical { border-left-color: var(--red); }
.jira-card.priority-high     { border-left-color: var(--amber); }
.jira-card.priority-medium   { border-left-color: var(--blue); }
.jira-card:hover { border-left-color: var(--accent) !important; }
.jira-key { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 500; color: var(--accent2); }
.jira-title { font-size: 12.5px; color: var(--soft); line-height: 1.55; flex: 1; }
.jira-priority {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; font-weight: 500;
  padding: 2px 8px;
  border: 1px solid;
  border-radius: 20px;
  text-transform: uppercase; letter-spacing: .04em;
}
.priority-critical { color: var(--red);   border-color: var(--red-border);   background: var(--red-bg); }
.priority-high     { color: var(--amber); border-color: var(--amber-border); background: var(--amber-bg); }
.priority-medium   { color: var(--blue);  border-color: var(--blue-border);  background: var(--blue-bg); }

/* â”€â”€ Debt items â”€â”€ */
.debt-row {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 14px 16px;
  border: 1px solid var(--border);
  border-left: 4px solid var(--border2);
  border-radius: var(--radius);
  background: var(--surface);
  margin-bottom: 8px;
  transition: all .2s;
}
.debt-row.critical { border-left-color: var(--red); }
.debt-row.high     { border-left-color: var(--amber); }
.debt-row.medium   { border-left-color: var(--blue); }
.debt-checkbox {
  width: 15px; height: 15px; cursor: pointer; margin-top: 3px;
  accent-color: var(--accent); flex-shrink: 0;
}
.debt-info { flex: 1; }
.debt-type-tag { font-family: 'JetBrains Mono', monospace; font-size: 9px; font-weight: 700; text-transform: uppercase; }
.debt-type-tag.critical { color: var(--red); }
.debt-type-tag.high     { color: var(--amber); }
.debt-type-tag.medium   { color: var(--blue); }
.debt-desc { font-size: 12.5px; color: var(--soft); margin: 4px 0; line-height: 1.6; }
.debt-loc { font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--dim); }
.debt-cost-tag { text-align: right; flex-shrink: 0; }
.debt-cost-num { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; color: var(--red); }
.debt-effort { font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--dim); margin-top: 2px; }

/* â”€â”€ Repo display â”€â”€ */
.repo-box {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 16px;
  display: flex; align-items: center; gap: 12px;
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
}
.repo-icon { font-size: 18px; }
.repo-name { color: var(--accent2); font-weight: 500; }

/* â”€â”€ KPI boxes â”€â”€ */
.kpi-grid { display: grid; gap: 12px; }
.kpi-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
}
.kpi-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; color: var(--dim); letter-spacing: .1em; text-transform: uppercase; margin-bottom: 6px;
}
.kpi-val { font-size: 26px; line-height: 1.1; font-weight: 700; letter-spacing: -.5px; }
.kpi-val.red   { color: var(--red); }
.kpi-val.green { color: var(--green); }
.kpi-val.amber { color: var(--amber); }
.kpi-val.blue  { color: var(--blue); }
.kpi-sub { font-size: 10.5px; color: var(--dim); margin-top: 3px; }

/* â”€â”€ Negotiation cards â”€â”€ */
.nego-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: start; }
.nego-vs { padding-top: 50px; font-size: 22px; font-weight: 700; color: var(--border2); text-align: center; }
.nego-card { border: 1.5px solid; padding: 18px; border-radius: var(--radius); }
.nego-card.opt-a { border-color: var(--red-border); background: var(--red-bg); }
.nego-card.opt-b { border-color: var(--green-border); background: var(--green-bg); }
.nego-card-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; letter-spacing: .15em; text-transform: uppercase; margin-bottom: 6px; font-weight: 600;
}
.nego-card-label.a { color: var(--red); }
.nego-card-label.b { color: var(--green); }
.nego-card-title { font-size: 16px; font-weight: 700; margin-bottom: 14px; }
.nego-stat {
  display: flex; justify-content: space-between;
  padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 11.5px;
}
.nego-stat:last-child { border-bottom: none; }
.nego-stat-label { color: var(--muted); }
.nego-stat-val { font-family: 'JetBrains Mono', monospace; font-size: 11px; }

/* â”€â”€ Final dashboard â”€â”€ */
.final-kpi-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 10px; }
.final-kpi {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
}

/* â”€â”€ Recommendation box â”€â”€ */
.rec-box {
  padding: 18px 22px;
  border: 1px solid var(--green-border);
  border-left: 4px solid var(--green);
  background: var(--green-bg);
  border-radius: var(--radius);
}
.rec-label { font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--green); letter-spacing: .12em; margin-bottom: 6px; font-weight: 600; }
.rec-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
.rec-body { font-size: 12.5px; color: var(--soft); line-height: 1.75; }

/* â”€â”€ Section headers â”€â”€ */
.section-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; letter-spacing: -.3px; }
.section-sub { font-size: 11.5px; color: var(--dim); margin-bottom: 14px; }

/* â”€â”€ Layouts â”€â”€ */
.two-col   { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* â”€â”€ Pills â”€â”€ */
.pill {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; padding: 2px 8px;
  letter-spacing: .04em; text-transform: uppercase;
  border-radius: 20px; font-weight: 600;
}
.pill-red   { background: var(--red-bg);   color: var(--red);   border: 1px solid var(--red-border); }
.pill-amber { background: var(--amber-bg); color: var(--amber); border: 1px solid var(--amber-border); }
.pill-blue  { background: var(--blue-bg);  color: var(--blue);  border: 1px solid var(--blue-border); }
.pill-green { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
@keyframes spin   { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
@keyframes pulse  { 0%,100%{opacity:1;} 50%{opacity:.4;} }
.fade-in { animation: fadeIn .3s ease both; }
.spin    { display:inline-block; animation:spin 1s linear infinite; }
.pulse   { animation:pulse 1.5s ease infinite; }

/* â”€â”€ Progress â”€â”€ */
.prog-bar  { height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
.prog-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); transition: width .4s ease; }

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--border2); }

/* â”€â”€ Stepper â”€â”€ */
.stepper {
  display: flex; align-items: center;
  padding: 0 24px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0; height: 56px; overflow: hidden;
}
.step { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.step-dot {
  width: 28px; height: 28px;
  border-radius: 50%;
  border: 2px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; color: var(--dim);
  background: var(--surface2); flex-shrink: 0;
  transition: all .3s;
}
.step.done .step-dot   { border-color: var(--green); background: var(--green-bg); color: var(--green); font-size: 10px; }
.step.active .step-dot { border-color: var(--accent); background: var(--accent-bg); color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,.18); }
.step-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; font-weight: 500; letter-spacing: .06em; text-transform: uppercase;
  color: var(--dim); white-space: nowrap;
}
.step.done .step-label   { color: var(--green); }
.step.active .step-label { color: var(--accent2); }
.step-line { flex: 1; height: 1px; background: var(--border2); min-width: 16px; transition: background .3s; }
.step-line.done { background: var(--green); }

/* â”€â”€ Agent flow steps â”€â”€ */
.agent-steps { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
.agent-step {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; padding: 4px 12px;
  border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--dim);
}
.agent-step.active { border-color: var(--amber); color: var(--amber); background: var(--amber-bg); }
.agent-step.done   { border-color: var(--green); color: var(--green); background: var(--green-bg); }
.agent-step-arrow  { color: var(--border2); font-size: 10px; }

/* â”€â”€ Input â”€â”€ */
.input-field {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  padding: 8px 12px;
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  outline: none; width: 100%;
  transition: border-color .15s;
}
.input-field:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,.15); }
.input-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; color: var(--dim); letter-spacing: .1em; text-transform: uppercase;
  display: block; margin-bottom: 5px;
}

/* â”€â”€ Phase header â”€â”€ */
.phase-header {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 18px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  border-radius: var(--radius);
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}
.phase-icon  { font-size: 22px; }
.phase-title { font-size: 17px; font-weight: 700; letter-spacing: -.2px; }
.phase-sub   { font-size: 11.5px; color: var(--dim); margin-top: 2px; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback} = React;

const fmt = n => '$'+Math.round(n).toLocaleString();
const wait = ms => new Promise(r => setTimeout(r, ms));

// â”€â”€ All Products â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRODUCTS_DATA = {

  'fraud-detection': {
    icon: 'ğŸ¤–',
    label: 'Fraud Detection ML Platform',
    description: 'ML pipeline powering real-time fraud detection',
    project: { name:'Fraud Detection ML Platform', key:'ML', id:'ML-1401', backlogUrl:'https://pnp16.atlassian.net/jira/software/projects/ML/boards/backlog' },
    jiraItems: [
      { key:'ML-1401', title:'Fraud alerts take 5+ minutes â€” customers want instant notifications', priority:'critical', repo:'ml-inference-engine', points:13 },
      { key:'ML-1402', title:'Our fraud model is 15 months out of date â€” it is missing new scam patterns', priority:'critical', repo:'training-orchestrator', points:21 },
      { key:'ML-1403', title:'Predictions in testing look great but break in production â€” data mismatch', priority:'high', repo:'feature-store-service', points:8 },
      { key:'ML-1404', title:'Regulators are asking why we flagged a transaction â€” we cannot explain it', priority:'high', repo:'ml-inference-engine', points:13 },
    ],
    repoData: {
      'ml-inference-engine': {
        name:'ml-inference-engine', description:'Core ML model serving & prediction API',
        language:'Python / FastAPI', files:147, stars:89, lastCommit:'3 days ago',
        debts:[
          { id:'D1', severity:'critical', type:'Batch-Only Pipeline', description:'Every fraud check joins a queue and is processed in bulk every 5 minutes. There is no way to check a single transaction the moment it happens â€” making real-time alerts impossible with the current setup.', annual_cost:520000, fix_weeks:6 },
          { id:'D2', severity:'critical', type:'No Safe Rollback', description:'If a bad model update goes live, fixing it means engineers manually swapping files on the server â€” a process that takes 4 hours and causes a full outage. There is no one-click rollback. Three incidents in the last 6 months cost the business $120K.', annual_cost:380000, fix_weeks:4 },
          { id:'D3', severity:'high', type:'One File Does Everything', description:'A single code file is responsible for 6,200 lines of logic covering loading models, cleaning data, running predictions, caching results, and monitoring â€” all tangled together. Nobody fully understands it, so any change carries high risk of breaking something else.', annual_cost:210000, fix_weeks:5 },
          { id:'D4', severity:'high', type:'Hardcoded Business Rules', description:'47 data transformation rules are scattered across 12 different files with no documentation. Changing one rule unpredictably breaks three others. Adding a new data source or updating a rule requires a full investigation before touching anything.', annual_cost:175000, fix_weeks:3 },
          { id:'D5', severity:'medium', type:'No Performance Monitoring', description:'There are no automatic checks on how well the fraud model is performing day-to-day. When accuracy drops, customers notice fraudulent transactions slipping through before the engineering team does. Average time to detect a model failure is 11 days.', annual_cost:95000, fix_weeks:2 },
        ]
      },
      'training-orchestrator': {
        name:'training-orchestrator', description:'ML training pipeline & experiment tracking',
        language:'Python / Airflow', files:89, stars:34, lastCommit:'12 days ago',
        debts:[
          { id:'D6', severity:'critical', type:'15-Month-Old Training Data', description:'The fraud model has not been retrained in 15 months. It has never seen any scam patterns that emerged in the past year. As a result, detection accuracy has fallen from 94% to 67% â€” meaning 1 in 3 fraud cases is now being missed.', annual_cost:440000, fix_weeks:5 },
          { id:'D7', severity:'high', type:'Experiments Tracked in Spreadsheets', description:'There is no system to record what data, settings, or code produced each model. Past results cannot be reproduced. If regulators ask which inputs led to a decision, the team cannot answer. Every new experiment starts from scratch with no institutional memory.', annual_cost:185000, fix_weeks:3 },
          { id:'D8', severity:'medium', type:'Training Limited to One Machine', description:'The model training process is locked to a single server and cannot be split across multiple machines. Training a large model takes up to 72 hours, limiting the team to one experiment per week and blocking engineers from trying new approaches quickly.', annual_cost:120000, fix_weeks:4 },
        ]
      },
      'feature-store-service': {
        name:'feature-store-service', description:'Centralised ML feature storage and serving',
        language:'Python / Redis / Spark', files:62, stars:21, lastCommit:'8 days ago',
        debts:[
          { id:'D9', severity:'high', type:'Test Results Don\'t Match Production', description:'The data the model is trained and tested on is calculated differently from the data it sees when running live. This mismatch causes an 8% accuracy gap between what the team sees in testing and what actually happens in production â€” giving false confidence before launch.', annual_cost:290000, fix_weeks:5 },
          { id:'D10', severity:'medium', type:'No Audit Trail for Model Inputs', description:'Nobody tracks which data inputs each model version relies on. When something changes upstream, the impact on models is invisible until a failure occurs in production. The compliance team cannot produce an audit trail, which is currently blocking regulatory approval.', annual_cost:140000, fix_weeks:2 },
        ]
      },
    },
    nego: {
      optA_items: [
        'Fraud alerts stay delayed 5+ min â€” batch pipeline blocks real-time',
        'Model accuracy stuck at 67% and falling every week',
        'Touching any data rule risks silent bugs across 12 files',
        'Regulators reject compliance dashboard â€” decisions unexplainable',
        'Bad deploys still mean 4h outage â€” no rollback exists',
      ],
      optB_items: [
        'Fraud alerts under 1 second â€” real-time pipeline replaces batch',
        'Model accuracy back to 94%+ with automated weekly retraining',
        'Data rules safe to change â€” documented, centralised, tested',
        'Every decision explainable â€” compliance unblocked',
        'One-click rollback â€” no more 4h outages from bad deploys',
      ],
      dashFinalTitle: 'Refactor ML Infrastructure First',
      dashNote: 'The monolithic batch pipeline and 15-month-old training data are directly blocking the majority of JIRA features. Building on current infrastructure = 65% regression risk + $23K/month compounding. Refactoring enables real-time inference, auto-retraining, and XAI compliance â€”',
    },
  },

  'payment-platform': {
    icon: 'ğŸ’³',
    label: 'Payment Platform',
    description: 'Core payment processing & checkout infrastructure',
    project: { name:'Payment Platform', key:'PAY', id:'PAY-2001', backlogUrl:'https://pnp16.atlassian.net/jira/software/projects/PAY/boards/backlog' },
    jiraItems: [
      { key:'PAY-2001', title:'Add Apple Pay & Google Wallet â€” checkout options every competitor already offers', priority:'critical', repo:'payment-platform-tech-debt', points:13 },
      { key:'PAY-2002', title:'Checkout failure rate is 3.2% â€” every failed payment is $340K/month in abandoned carts', priority:'critical', repo:'payment-platform-tech-debt', points:21 },
      { key:'PAY-2003', title:'PCI-DSS compliance audit deadline is Q2 â€” failing means losing card processing rights', priority:'high', repo:'payment-platform-tech-debt', points:13 },
      { key:'PAY-2004', title:'Deployments take 4 hours and fail 1 in 5 times â€” engineers spend 20% of their week on this', priority:'high', repo:'payment-platform-tech-debt', points:8 },
    ],
    repoData: {
      'payment-platform-tech-debt': {
        name:'payment-platform-tech-debt', description:'Core payment processing & checkout platform',
        language:'Java / Spring Boot', files:312, stars:45, lastCommit:'2 days ago',
        debts:[
          { id:'P1', severity:'critical', type:'God Commons Library', description:'A single shared library is imported by all 23 microservices. Any change to it requires redeploying the entire payment platform simultaneously â€” a coordinated 3-day effort that blocks all other work. At Amazon, this exact pattern caused 3-day deploy cycles across teams.', annual_cost:268000, fix_weeks:6 },
          { id:'P2', severity:'critical', type:'Hardcoded API Keys & Config Sprawl', description:'Production API keys are hardcoded in a checked-in config file visible to anyone with repo access. On top of this, 147 feature flags are still evaluated on every payment request â€” 89 belong to experiments that ended over 2 years ago and were never cleaned up. This directly mirrors the Uber God Mode breach caused by hardcoded admin credentials.', annual_cost:312000, fix_weeks:4 },
          { id:'P3', severity:'critical', type:'Log4Shell Vulnerability (CVE-2021-44228)', description:'The shared logging library runs Log4j 1.2.17, which carries the critical Log4Shell remote code execution exploit â€” the same vulnerability that affected millions of services in 2021. It remains unpatched here, leaving the entire payment platform open to a known attack vector.', annual_cost:240000, fix_weeks:3 },
          { id:'P4', severity:'high', type:'PaymentController Does Everything', description:'One Java class handles all 15 payment methods in 4,500 lines of code. No part of payment processing can be changed without risking a break in another. Adding Apple Pay or Google Wallet means modifying this class â€” a change that currently takes 3x longer than it should due to regression risk.', annual_cost:200000, fix_weeks:5 },
          { id:'P5', severity:'high', type:'89 Dead Feature Flags Running on Every Payment', description:'89 feature flags from finished A/B experiments are still loaded and evaluated on every single payment request â€” adding latency and confusion for no benefit. When LinkedIn cleaned up a similar backlog, they saw an immediate 15% performance improvement.', annual_cost:150000, fix_weeks:2 },
          { id:'P6', severity:'medium', type:'Four Payment Providers, Four Different Patterns', description:'Each payment provider was integrated by a different team using a different approach. The Amazon Pay integration has been sitting at 45% completion for 8 months. Adding any new payment method currently requires reworking the entire integration layer from scratch.', annual_cost:120000, fix_weeks:4 },
          { id:'P7', severity:'medium', type:'800-Line Deploy Script With No Safety Net', description:'The platform is deployed via a single shell script with no error handling, no rollback, and no validation. One in every five deployments fails and requires manual intervention to recover. Knight Capital lost $440M in 45 minutes in 2012 from a deploy script with exactly this problem.', annual_cost:100000, fix_weeks:3 },
          { id:'P8', severity:'medium', type:'Critical Knowledge Exists Only in Two People\'s Heads', description:'The README says "See John for questions." John left in 2021. How the payment routing logic works is known to exactly two engineers. Onboarding a new team member currently takes 4 weeks instead of 1 week, and a single resignation could leave the team unable to safely change core payment logic.', annual_cost:80000, fix_weeks:2 },
        ]
      },
    },
    nego: {
      optA_items: [
        'Apple Pay & Google Wallet blocked â€” PaymentController too fragile to modify safely',
        'Log4Shell vulnerability unpatched â€” platform open to known remote code execution',
        'Checkout failures stay at 3.2% â€” $340K/month in abandoned carts continues',
        'PCI-DSS audit approaching â€” hardcoded API keys likely to fail compliance check',
        'Deploy failures at 20% rate â€” engineers lose 1 day per week to rollback drills',
      ],
      optB_items: [
        'Apple Pay & Google Wallet ship cleanly â€” PaymentController split into safe modules',
        'Log4Shell patched â€” platform protected before Q2 PCI-DSS audit',
        'Checkout failure rate drops â€” dead feature flags and config sprawl eliminated',
        'PCI-DSS compliance met â€” hardcoded keys removed, secrets in vault',
        'Deploys safe and fast â€” script replaced with validated, rollback-capable pipeline',
      ],
      dashFinalTitle: 'Refactor Payment Platform First',
      dashNote: 'The God Commons Library and unpatched Log4Shell are directly blocking all JIRA features. Building on current infrastructure = 65% regression risk and a pending PCI-DSS audit failure. Refactoring enables safe modular changes, compliance, and reliable deployments â€”',
    },
  },

};


// â”€â”€ Stepper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STEPS = [
  {id:'jira',      icon:'ğŸ«', label:'JIRA Backlog'},
  {id:'repo',      icon:'ğŸ“', label:'Repository'},
  {id:'debt',      icon:'ğŸ¤–', label:'Debt Analysis'},
  {id:'cost',      icon:'ğŸ’°', label:'Cost Model'},
  {id:'nego',      icon:'âš–ï¸', label:'Negotiation'},
  {id:'dashboard', icon:'ğŸ“Š', label:'Report'},
];
const PHASE_ORDER = STEPS.map(s=>s.id);

function Stepper({phase}) {
  const current = PHASE_ORDER.indexOf(phase);
  return (
    <div className="stepper">
      {STEPS.map((s,i)=>{
        const done   = i < current;
        const active = i === current;
        return (
          <React.Fragment key={s.id}>
            <div className={`step ${done?'done':''} ${active?'active':''}`}>
              <div className="step-dot">{done ? 'âœ“' : s.icon}</div>
              <div className="step-label">{s.label}</div>
            </div>
            {i < STEPS.length-1 && <div className={`step-line ${i<current?'done':''}`}/>}
          </React.Fragment>
        );
      })}
    </div>
  );
}

// â”€â”€ Log panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LogPanel({logs}) {
  const [open, setOpen] = useState(false);
  const ref = useRef(null);
  useEffect(()=>{ if(ref.current) ref.current.scrollTop = ref.current.scrollHeight; },[logs]);
  return (
    <div className="log-panel" style={{width: open ? 300 : 36, transition:'width .25s ease', overflow:'hidden'}}>
      <div className="log-panel-header" style={{cursor:'pointer', justifyContent:'center', padding:'10px 8px'}}
        onClick={()=>setOpen(o=>!o)}>
        {open ? (
          <>
            <span style={{flex:1}}>Agent Logs</span>
            <span className="badge badge-live" style={{marginRight:6}}>{logs.length}</span>
            <span style={{fontSize:11, color:'var(--dim)'}}>âœ•</span>
          </>
        ) : (
          <span title="Show agent logs" style={{fontSize:14, writingMode:'vertical-rl', transform:'rotate(180deg)', color:'var(--dim)', letterSpacing:'.08em', fontFamily:"'JetBrains Mono',monospace", fontSize:'9px', textTransform:'uppercase'}}>
            Logs {logs.length > 0 ? `(${logs.length})` : ''}
          </span>
        )}
      </div>
      {open && (
        <div className="log-panel-body" ref={ref}>
          {logs.length === 0 && <div className="log-line log-dim">Waiting for activityâ€¦</div>}
          {logs.map((l,i)=>(
            <div key={i} className={`log-line log-${l.type}`}>{l.msg}</div>
          ))}
        </div>
      )}
    </div>
  );
}

// â”€â”€ Phase 1: JIRA Backlog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function jiraIssueUrl(key, projectKey) {
  return `https://pnp16.atlassian.net/jira/software/projects/${projectKey}/issues/${key}`;
}

function PhaseJira({onSelect, selectedItem, logs, running, onLoad, activeProduct, onProductChange, jiraItems, project}) {
  const [jiraUrl, setJiraUrl] = React.useState(project.backlogUrl);
  React.useEffect(()=>{ setJiraUrl(project.backlogUrl); }, [project.backlogUrl]);

  return (
    <div className="fade-in">

      {/* Product selector */}
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:10}}>
        {Object.entries(PRODUCTS_DATA).map(([id, p])=>(
          <div key={id}
            onClick={()=>{ if(id!==activeProduct) onProductChange(id); }}
            style={{
              padding:'14px 18px', cursor:'pointer', transition:'all .2s',
              border: id===activeProduct ? '1.5px solid var(--accent)' : '1.5px solid var(--border)',
              borderRadius:'10px',
              background: id===activeProduct ? 'var(--accent-bg)' : 'var(--surface)',
              display:'flex', alignItems:'center', gap:12,
              boxShadow: id===activeProduct ? '0 0 0 1px rgba(59,130,246,.3),0 4px 14px rgba(59,130,246,.12)' : '0 1px 3px rgba(0,0,0,.3)',
            }}>
            <div style={{fontSize:24,flexShrink:0}}>{p.icon}</div>
            <div>
              <div style={{fontFamily:"'Plus Jakarta Sans',sans-serif",fontSize:14,fontWeight:600,color: id===activeProduct?'var(--accent2)':'var(--text)'}}>{p.label}</div>
              <div style={{fontSize:'10px',color:'var(--dim)',marginTop:2}}>{p.description}</div>
            </div>
            {id===activeProduct && <span className="badge badge-live" style={{marginLeft:'auto',flexShrink:0}}>ACTIVE</span>}
          </div>
        ))}
      </div>

      <div className="phase-header" style={{flexDirection:'column',alignItems:'stretch',gap:14,padding:'18px 20px'}}>
        {/* Top row: icon + title + button */}
        <div style={{display:'flex',alignItems:'center',gap:12}}>
          <div className="phase-icon" style={{fontSize:24}}>ğŸ«</div>
          <div style={{flex:1}}>
            <div className="phase-title" style={{fontSize:20}}>{project.id} â€” {project.name}</div>
            <div className="phase-sub" style={{marginTop:3}}>
              Roadmap backlog â€” tech debt blockers flagged by engineering. Paste your own JIRA backlog URL below, then click Load.
            </div>
          </div>
          {!logs.length && (
            <button className="btn btn-primary" style={{flexShrink:0}} onClick={onLoad} disabled={running}>
              {running ? <><span className="spin">âŸ³</span> Loadingâ€¦</> : 'â–¶ Load JIRA Backlog'}
            </button>
          )}
        </div>

        {/* JIRA URL input row */}
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'10px',color:'var(--dim)',whiteSpace:'nowrap',letterSpacing:'.06em'}}>
            JIRA BACKLOG URL
          </span>
          <div style={{flex:1,position:'relative'}}>
            <input
              className="input-field"
              value={jiraUrl}
              onChange={e=>setJiraUrl(e.target.value)}
              spellCheck={false}
              style={{paddingLeft:28,fontSize:'11px',letterSpacing:'.02em'}}
            />
            <span style={{position:'absolute',left:9,top:'50%',transform:'translateY(-50%)',fontSize:'11px',pointerEvents:'none'}}>ğŸ”—</span>
          </div>
          <a href={jiraUrl} target="_blank" rel="noopener noreferrer"
            style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'10px',color:'var(--blue)',textDecoration:'none',
                    padding:'7px 12px',border:'1px solid var(--blue-border)',borderRadius:'6px',whiteSpace:'nowrap',flexShrink:0}}>
            Open â†—
          </a>
        </div>
      </div>

      {logs.length > 0 && (
        <div className="fade-in">
          <div style={{marginBottom:8,fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--dim)',letterSpacing:'.1em',textTransform:'uppercase'}}>
            {jiraItems.length} blocker items Â· Click a ticket to trace its repository
          </div>
          <div className="jira-grid">
            {jiraItems.map(item=>(
              <div key={item.key}
                className={`jira-card priority-${item.priority} ${selectedItem?.key===item.key?'selected':''}`}
                onClick={()=>onSelect(item)}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                  <span className="jira-key">{item.key}</span>
                  <span className={`jira-priority priority-${item.priority}`}>{item.priority}</span>
                </div>
                <div className="jira-title">{item.title}</div>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:'auto'}}>
                  <a href={jiraIssueUrl(item.key, project.key)} target="_blank" rel="noopener noreferrer"
                    style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--blue)',textDecoration:'none'}}
                    onClick={e=>e.stopPropagation()}>
                    ğŸ”— Open ticket
                  </a>
                  <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--dim)'}}>{item.points}pts</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€ Phase 2: Repository â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseRepo({selectedJira, repoName, repoData, onScan, scanning, scanned}) {
  const repo = repoData[repoName];
  return (
    <div className="fade-in">
      <div className="card" style={{marginBottom:14}}>
        <div className="card-head" style={{padding:'14px 18px'}}>
          <span style={{fontFamily:"'Plus Jakarta Sans',sans-serif",fontWeight:700,fontSize:20,color:'var(--text)',letterSpacing:'.01em'}}>
            ğŸ“ Linked Repository
          </span>
          <span className="badge badge-live" style={{marginLeft:'auto'}}>LOADED</span>
        </div>
        <div className="card-body">
          <div className="repo-box">
            <div className="repo-icon">âš™ï¸</div>
            <div>
              <div className="repo-name">{repoName}</div>
              <div style={{fontSize:'10px',color:'var(--dim)'}}>{repo?.description}</div>
            </div>
            <div style={{marginLeft:'auto',textAlign:'right'}}>
              <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'10px',color:'var(--dim)'}}>{repo?.language}</div>
              <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'10px',color:'var(--dim)'}}>{repo?.files} files Â· last commit {repo?.lastCommit}</div>
            </div>
          </div>
          <div style={{marginTop:12}}>
            <label className="input-label">Repository URL</label>
            <input className="input-field" readOnly value={`https://github.com/your-org/${repoName}`}/>
          </div>
        </div>
      </div>

      {!scanned && (
        <button className="btn btn-primary btn-block" onClick={onScan} disabled={scanning}>
          {scanning ? <><span className="spin">âŸ³</span> Scanningâ€¦</> : 'ğŸ” Scan Repositories'}
        </button>
      )}
    </div>
  );
}

// â”€â”€ Phase 3: Debt Items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseDebt({debts, selected, onToggle, onCalc, calculating, costData}) {
  const total = debts.filter(d=>selected.includes(d.id)).reduce((s,d)=>s+d.annual_cost,0);
  return (
    <div className="fade-in">
      <div className="phase-header">
        <div className="phase-icon">ğŸ¤–</div>
        <div>
          <div className="phase-title">Debt Items Detected</div>
          <div className="phase-sub">AI-identified technical debt across linked repositories. Select items to include in cost calculation.</div>
        </div>
        <div style={{marginLeft:'auto',textAlign:'right'}}>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--dim)'}}>SELECTED ANNUAL COST</div>
          <div style={{fontFamily:"'Plus Jakarta Sans',sans-serif",fontWeight:700,fontSize:'22px',color:'var(--red)'}}>{fmt(total)}</div>
        </div>
      </div>

      <div style={{maxHeight:'calc(100vh - 380px)',overflowY:'auto',marginBottom:14}}>
        {debts.map(d=>(
          <div key={d.id} className={`debt-row ${d.severity}`}>
            <input type="checkbox" className="debt-checkbox"
              checked={selected.includes(d.id)}
              onChange={()=>onToggle(d.id)}/>
            <div className="debt-info">
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
                <span className={`pill pill-${d.severity==='critical'?'red':d.severity==='high'?'amber':'blue'}`}>{d.severity}</span>
                <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'10px',fontWeight:700,color: d.severity==='critical'?'var(--red)':d.severity==='high'?'var(--amber)':'var(--blue)'}}>{d.type}</span>
              </div>
              <div style={{fontSize:'14px',color:'var(--text)',lineHeight:1.6}}>{d.description}</div>
            </div>
            <div className="debt-cost-tag" style={{textAlign:'right',whiteSpace:'nowrap'}}>
              <div className="debt-cost-num">{fmt(d.annual_cost)}/yr</div>
              <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--dim)'}}>if left unfixed</div>
              <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--green)',marginTop:4}}>{d.fix_weeks}w to fix</div>
            </div>
          </div>
        ))}
      </div>

      {!costData && (
        <button className="btn btn-primary btn-block" onClick={onCalc} disabled={calculating||selected.length===0}>
          {calculating ? <><span className="spin">âŸ³</span> Calculatingâ€¦</> : `ğŸ’° Calculate Effort & Cost (${selected.length} items selected)`}
        </button>
      )}
    </div>
  );
}

// â”€â”€ Phase 4: Cost Preview (Live) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseCost({costData, selectedDebts, allDebts, onNegotiate, negotiating, negotiation}) {
  return (
    <div className="fade-in">
      <div className="phase-header">
        <div className="phase-icon">ğŸ’°</div>
        <div>
          <div className="phase-title">What Does Fixing This Actually Cost?</div>
          <div className="phase-sub">Based on the issues selected above â€” how much to fix them, how much they save, and when you break even.</div>
        </div>
      </div>

      <div className="three-col" style={{marginBottom:14}}>
        {[
          {label:'Refactoring Cost',val:fmt(costData.refactoring_cost),cls:'amber',sub:`${costData.effort_weeks}w Ã— 4 engineers`},
          {label:'Annual Savings',val:fmt(costData.annual_savings),cls:'green',sub:'Debt costs eliminated'},
          {label:'Break-Even',val:`Wk ${costData.break_even_weeks}`,cls:'blue',sub:'Then saves forever'},
          {label:'First-Year ROI',val:`${costData.roi_pct}%`,cls:costData.roi_pct>0?'green':'red',sub:'Return on investment'},
          {label:'Critical Issues',val:costData.critical_count,cls:'red',sub:`${costData.total_count} total selected`},
          {label:'Prod Risk (Build Now)',val:'65%',cls:'red',sub:'Regression probability'},
        ].map((k,i)=>(
          <div key={i} className="kpi-box">
            <div className="kpi-label">{k.label}</div>
            <div className={`kpi-val ${k.cls}`}>{k.val}</div>
            <div className="kpi-sub">{k.sub}</div>
          </div>
        ))}
      </div>

      {!negotiation && (
        <button className="btn btn-blue btn-block" onClick={onNegotiate} disabled={negotiating}>
          {negotiating ? <><span className="spin">âŸ³</span> Running Negotiation Agentâ€¦</> : 'âš–ï¸ Run Negotiations'}
        </button>
      )}
    </div>
  );
}

// â”€â”€ Phase 5: Negotiation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseNego({negotiation, costData, nego, jiraCount, onDashboard}) {
  return (
    <div className="fade-in">
      <div className="phase-header">
        <div className="phase-icon">âš–ï¸</div>
        <div>
          <div className="phase-title">Negotiation Agent â€” Refactor vs Build</div>
          <div className="phase-sub">AI agent cross-references debt impact against JIRA feature blockers and models both paths.</div>
        </div>
      </div>

      <div className="nego-grid" style={{marginBottom:14}}>
        <div className="nego-card opt-a">
          <div className="nego-card-label a">OPTION A</div>
          <div className="nego-card-title">Build Features Now</div>
          {[
            ['Timeline','16 weeks'],['Success Rate','35%'],['Risk','HIGH'],
            ['Regression Risk','65%'],['Ongoing Cost','$23K/mo'],['Break-Even','Never (costs grow)'],
          ].map(([l,v],i)=>(
            <div key={i} className="nego-stat">
              <span className="nego-stat-label">{l}</span>
              <span className="nego-stat-val" style={{color:i===1||i===2?'var(--red)':undefined}}>{v}</span>
            </div>
          ))}
          <div style={{marginTop:12,fontSize:'11px',color:'var(--red)',lineHeight:1.9}}>
            <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--dim)',marginBottom:6,letterSpacing:'.08em'}}>WHAT HAPPENS NEXT</div>
            {nego.optA_items.map((item,i)=><div key={i}>âœ— {item}</div>)}
            <div>âœ— {fmt(costData.annual_savings)}/yr in debt costs keep compounding</div>
          </div>
        </div>

        <div className="nego-vs">vs</div>

        <div className="nego-card opt-b">
          <div className="nego-card-label b">OPTION B â€” RECOMMENDED</div>
          <div className="nego-card-title">Refactor First, Then Build</div>
          {[
            ['Refactor','12 weeks'],['Feature Build','4 weeks'],['Total','16 weeks'],
            ['Success Rate','92%'],['Risk','LOW'],['Break-Even',`Week ${costData.break_even_weeks}`],
          ].map(([l,v],i)=>(
            <div key={i} className="nego-stat">
              <span className="nego-stat-label">{l}</span>
              <span className="nego-stat-val" style={{color:i===3||i===4?'var(--green)':undefined}}>{v}</span>
            </div>
          ))}
          <div style={{marginTop:12,fontSize:'11px',color:'var(--green)',lineHeight:1.9}}>
            <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--dim)',marginBottom:6,letterSpacing:'.08em'}}>WHAT YOU UNLOCK</div>
            {nego.optB_items.map((item,i)=><div key={i}>âœ“ {item}</div>)}
            <div>âœ“ {fmt(costData.annual_savings)}/yr saved â€” all {jiraCount} features ship cleanly</div>
          </div>
        </div>
      </div>

      <div className="rec-box" style={{marginBottom:14}}>
        <div className="rec-label">âœ“ AGENT RECOMMENDATION</div>
        <div className="rec-title">Refactor First â€” Then Ship All {jiraCount} Features</div>
        <div className="rec-body" style={{marginBottom:16}}>{negotiation.reason}</div>

        {/* Tradeoff grid */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:1,background:'rgba(255,255,255,.06)',marginBottom:14}}>
          {[
            {label:'Success rate gap',val:'35% â†’ 92%',note:'+57 points in your favour',cls:'green'},
            {label:'Time to working feature',val:`${costData.effort_weeks+4}w vs 16w+`,note:`Option B: ${costData.effort_weeks}w refactor + 4w build, ships once. Option A: 8w build + 8w+ rework after the 65% regression hits.`,cls:'blue'},
            {label:'If Option A fails',val:'Refactor anyway',note:`Both paths combined = ${costData.effort_weeks+16}w & double the cost`,cls:'red'},
            {label:'First-year net gain',val:fmt(costData.annual_savings - costData.refactoring_cost),note:`after paying back the ${fmt(costData.refactoring_cost)} investment`,cls:'green'},
          ].map((t,i)=>(
            <div key={i} style={{padding:'10px 14px',background:'var(--surface2)'}}>
              <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--dim)',marginBottom:3,letterSpacing:'.06em'}}>{t.label.toUpperCase()}</div>
              <div style={{fontFamily:"'Plus Jakarta Sans',sans-serif",fontWeight:700,fontSize:'15px',color:`var(--${t.cls})`}}>{t.val}</div>
              <div style={{fontSize:'10px',color:'var(--dim)',marginTop:2}}>{t.note}</div>
            </div>
          ))}
        </div>

        {/* Confidence signal */}
        <div style={{padding:'10px 14px',border:'1px solid var(--green-border)',background:'var(--green-bg)',borderRadius:'8px'}}>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--green)',letterSpacing:'.08em',marginBottom:4}}>WHY THIS IS A CLEAR CALL, NOT A CLOSE CALL</div>
          <div style={{fontSize:'11px',color:'var(--soft)',lineHeight:1.7}}>
            The gap between Option A (35%) and Option B (92%) is <strong style={{color:'var(--text)'}}>57 percentage points</strong> â€” well above the 15-point threshold where the choice becomes a judgement call. Option A's 8-week promise is misleading: with a 65% regression rate on this codebase, history shows the real timeline becomes 16 weeks or more once debugging and rollbacks are counted. Option B delivers in <strong style={{color:'var(--text)'}}>{costData.effort_weeks+4} weeks with one predictable schedule</strong> and no hidden rework. The only scenario where Option A wins is if the debt is low-severity and the team is confident the workarounds hold â€” neither is true here.
          </div>
        </div>
      </div>

      <button className="btn btn-success btn-block" onClick={onDashboard}>
        ğŸ“Š View Final Dashboard â†’
      </button>
    </div>
  );
}

// â”€â”€ Phase 6: Final Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PhaseDashboard({costData, negotiation, selectedDebts, allDebts, nego, jiraItems}) {
  const debts = allDebts.filter(d=>selectedDebts.includes(d.id));
  return (
    <div className="fade-in">
      <div className="phase-header" style={{borderLeftColor:'var(--green)'}}>
        <div className="phase-icon">ğŸ“Š</div>
        <div>
          <div className="phase-title">Final Dashboard â€” Tech Debt Report</div>
          <div className="phase-sub">Complete analysis ready to share with your PM, CTO, or engineering board.</div>
        </div>
        <span className="badge badge-live" style={{marginLeft:'auto'}}>ANALYSIS COMPLETE</span>
      </div>

      <div className="final-kpi-grid" style={{marginBottom:14}}>
        {[
          {label:'Annual Debt Cost',val:fmt(costData.annual_savings),cls:'red',sub:'eliminated after refactor'},
          {label:'Refactoring Investment',val:fmt(costData.refactoring_cost),cls:'amber',sub:`${costData.effort_weeks} weeks`},
          {label:'Break-Even',val:`Wk ${costData.break_even_weeks}`,cls:'green',sub:'then saves forever'},
          {label:'First-Year ROI',val:`${costData.roi_pct}%`,cls:'green',sub:'return on investment'},
          {label:'Features Unblocked',val:`${jiraItems.length}/${jiraItems.length}`,cls:'blue',sub:`All ${jiraItems.length} JIRA features`},
        ].map((k,i)=>(
          <div key={i} className="final-kpi">
            <div className="kpi-label">{k.label}</div>
            <div className={`kpi-val ${k.cls}`} style={{fontSize:'22px'}}>{k.val}</div>
            <div className="kpi-sub">{k.sub}</div>
          </div>
        ))}
      </div>

      <div className="rec-box" style={{marginBottom:14}}>
        <div className="rec-label">âœ“ FINAL RECOMMENDATION</div>
        <div className="rec-title">{nego.dashFinalTitle} â€” Ship All {jiraItems.length} Features by Week 16</div>
        <div className="rec-body">
          This platform carries <strong style={{color:'var(--red)'}}>{fmt(costData.annual_savings)}/year</strong> in quantified debt costs.
          {' '}{nego.dashNote} with 92% delivery confidence and break-even at Week {costData.break_even_weeks}.
        </div>
      </div>

      <div style={{marginBottom:14}}>
        <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--dim)',letterSpacing:'.1em',textTransform:'uppercase',marginBottom:8}}>
          Selected Debt Items ({debts.length})
        </div>
        {debts.map(d=>(
          <div key={d.id} className={`debt-row ${d.severity}`} style={{marginBottom:4}}>
            <div className="debt-info">
              <div><span className={`debt-type-tag ${d.severity}`}>[{d.type.replace(/_/g,' ').toUpperCase()}]</span> <span className={`pill pill-${d.severity==='critical'?'red':d.severity==='high'?'amber':'blue'}`}>{d.severity}</span></div>
              <div className="debt-desc">{d.description}</div>
            </div>
            <div className="debt-cost-tag">
              <div className="debt-cost-num">{fmt(d.annual_cost)}/yr</div>
              <div className="debt-effort">{d.fix_weeks}w fix</div>
            </div>
          </div>
        ))}
      </div>

      <div style={{padding:'14px 16px',background:'var(--surface)',border:'1px solid var(--border)',display:'flex',alignItems:'center',justifyContent:'space-around',flexWrap:'wrap',gap:16}}>
        {[['ğŸ«','JIRA Fetcher'],['ğŸ“','Repo Scanner'],['ğŸ¤–','Debt Analyzer'],['ğŸ’°','Cost Model'],['âš–ï¸','Negotiator']].map(([icon,label],i)=>(
          <div key={i} style={{textAlign:'center'}}>
            <div style={{fontSize:'24px'}}>{icon}</div>
            <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'9px',color:'var(--green)',marginTop:4}}>âœ“ {label}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [logs, setLogs] = useState([]);
  const [phase, setPhase] = useState('jira'); // jira | repo | debt | cost | nego | dashboard

  // Product selection
  const [activeProduct, setActiveProduct] = useState('fraud-detection');
  const product = PRODUCTS_DATA[activeProduct];
  const activeJiraItems = product.jiraItems;
  const activeRepoData = product.repoData;
  const activeProject = product.project;
  const ALL_DEBTS = Object.values(activeRepoData).flatMap(r => r.debts);

  // Jira
  const [jiraLoading, setJiraLoading] = useState(false);
  const [jiraLoaded, setJiraLoaded] = useState(false);
  const [selectedJira, setSelectedJira] = useState(null);

  // Repo
  const [scanning, setScanning] = useState(false);
  const [scanned, setScanned] = useState(false);

  // Debt
  const [selectedDebts, setSelectedDebts] = useState([]);
  const [calculating, setCalculating] = useState(false);
  const [costData, setCostData] = useState(null);

  // Nego
  const [negotiating, setNegotiating] = useState(false);
  const [negotiation, setNegotiation] = useState(null);

  const addLog = useCallback((msg, type='info') => setLogs(l=>[...l,{msg,type}]), []);

  const onProductChange = (productId) => {
    setActiveProduct(productId);
    setPhase('jira');
    setSelectedJira(null);
    setJiraLoaded(false);
    setScanned(false);
    setSelectedDebts([]);
    setCostData(null);
    setNegotiation(null);
    setLogs([]);
  };

  // Compute cost live based on selected debts
  const computeCost = (ids) => {
    const items = ALL_DEBTS.filter(d=>ids.includes(d.id));
    const annual_savings = items.reduce((s,d)=>s+d.annual_cost,0);
    const effort_weeks = items.reduce((s,d)=>s+d.fix_weeks,0);
    const refactoring_cost = effort_weeks * 4 * 8000; // 4 engineers Ã— $8k/week
    const break_even_weeks = annual_savings > 0 ? Math.ceil(refactoring_cost/(annual_savings/52)) : 0;
    const roi_pct = annual_savings > 0 ? Math.round(((annual_savings-refactoring_cost)/refactoring_cost)*100) : 0;
    const critical_count = items.filter(d=>d.severity==='critical').length;
    return { annual_savings, effort_weeks, refactoring_cost, break_even_weeks, roi_pct, critical_count, total_count:items.length };
  };

  // Load JIRA
  const loadJira = async () => {
    setJiraLoading(true);
    addLog(`â–¶ Connecting to JIRA Cloud (${activeProject.backlogUrl.split('/')[2]})â€¦`,'info');
    await wait(600);
    addLog('  âœ“ Authenticated via OAuth token','ok');
    await wait(400);
    addLog(`  ğŸ” Querying backlog: project=${activeProject.key} AND labels=tech-debt AND priority IN (Critical,High,Medium)`,'info');
    await wait(700);
    addLog(`  âœ“ Found ${activeJiraItems.length} blocker items linked to tech debt tracker`,'ok');
    activeJiraItems.forEach((item,i)=>{
      setTimeout(()=>addLog(`    ${item.key}: ${item.title} [${item.priority}]`,'dim'),i*120);
    });
    await wait(activeJiraItems.length*120+300);
    addLog('âœ“ JIRA backlog loaded â€” click an item to trace its repository','ok');
    setJiraLoaded(true);
    setJiraLoading(false);
  };

  const selectJira = async (item) => {
    setSelectedJira(item);
    addLog(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,'dim');
    addLog(`â–¶ Tracing ${item.key} â†’ repository dependencyâ€¦`,'info');
    await wait(400);
    addLog(`  âœ“ Repository linked: ${item.repo}`,'ok');
    addLog(`  ğŸ“¦ Cloning metadata for ${item.repo}â€¦`,'info');
    await wait(300);
    addLog(`  âœ“ ${activeRepoData[item.repo]?.files} files indexed`,'ok');
    setPhase('repo');
    setScanned(false);
    setSelectedDebts([]);
    setCostData(null);
    setNegotiation(null);
  };

  const scanRepo = async () => {
    setScanning(true);
    const repo = activeRepoData[selectedJira.repo];
    addLog(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,'dim');
    addLog(`â–¶ Scanning ${selectedJira.repo} for tech debtâ€¦`,'info');
    await wait(500);
    addLog(`  ğŸ¤– Claude analyzing ${repo.files} filesâ€¦`,'info');
    await wait(800);
    addLog(`  ğŸ” Pattern detection: god classes, batch pipelines, missing registriesâ€¦`,'info');
    await wait(600);
    repo.debts.forEach((d,i)=>{
      setTimeout(()=>addLog(`  âš  ${d.severity.toUpperCase()}: ${d.type} â€” ${fmt(d.annual_cost)}/yr`,d.severity==='critical'?'error':d.severity==='high'?'warn':'info'),i*200);
    });
    await wait(repo.debts.length*200+400);
    addLog(`âœ“ Found ${repo.debts.length} debt items (${fmt(repo.debts.reduce((s,d)=>s+d.annual_cost,0))}/yr total)`,'ok');
    const ids = repo.debts.map(d=>d.id);
    setSelectedDebts(ids);
    setScanning(false);
    setScanned(true);
    setPhase('debt');
  };

  const toggleDebt = (id) => {
    const next = selectedDebts.includes(id) ? selectedDebts.filter(x=>x!==id) : [...selectedDebts,id];
    setSelectedDebts(next);
    if(costData) setCostData(computeCost(next));
  };

  const calcCost = async () => {
    setCalculating(true);
    addLog(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,'dim');
    addLog(`â–¶ Calculating refactoring economics for ${selectedDebts.length} itemsâ€¦`,'info');
    await wait(500);
    const c = computeCost(selectedDebts);
    addLog(`  âœ“ Total annual cost: ${fmt(c.annual_savings)}`,'ok');
    await wait(400);
    addLog(`  âœ“ Refactoring effort: ${c.effort_weeks}w Ã— 4 engineers Ã— $8K/wk = ${fmt(c.refactoring_cost)}`,'ok');
    await wait(500);
    addLog(`  âœ“ Break-even: Week ${c.break_even_weeks}`,'ok');
    addLog(`  âœ“ First-year ROI: ${c.roi_pct}%`,'ok');
    await wait(300);
    addLog(`âœ“ Cost model ready`,'ok');
    setCostData(c);
    setCalculating(false);
    setPhase('cost');
  };

  const runNegotiation = async () => {
    setNegotiating(true);
    addLog(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,'dim');
    addLog(`â–¶ Running Negotiation Agent (Claude)â€¦`,'info');
    await wait(600);
    addLog(`  âš–ï¸  Cross-referencing ${selectedDebts.length} debt items vs. ${activeJiraItems.length} JIRA ticketsâ€¦`,'info');
    await wait(700);
    const blocked = activeJiraItems.filter(t=>t.repo===selectedJira?.repo||t.priority==='critical');
    addLog(`  ğŸš« ${blocked.length}/${activeJiraItems.length} features blocked or critically slowed by debt`,'warn');
    await wait(500);
    addLog(`  ğŸ¯ Option A (Build Now): 16w, 35% success, $23K/mo ongoing`,'warn');
    await wait(400);
    addLog(`  ğŸ¯ Option B (Refactor First): ${costData.effort_weeks+4}w, 92% success, saves ${fmt(costData.annual_savings)}/yr`,'info');
    await wait(600);
    addLog(`  âœ“ RECOMMENDATION: REFACTOR FIRST`,'ok');
    const nego = {
      recommendation:'refactor_first',
      reason:`${blocked.length} of ${activeJiraItems.length} features are blocked by critical debt in ${product.label}. Building now carries 65% regression risk plus $23K/month compounding maintenance. Refactoring (${costData.effort_weeks} weeks) enables all features at 92% confidence â€” and breaks even at Week ${costData.break_even_weeks}, generating ${fmt(costData.annual_savings)}/year thereafter.`,
    };
    setNegotiation(nego);
    setNegotiating(false);
    setPhase('nego');
    addLog(`âœ“ Negotiation complete â€” recommendation ready`,'ok');
  };

  const activeRepo = selectedJira ? activeRepoData[selectedJira.repo] : null;
  const activeDebts = activeRepo ? activeRepo.debts : [];

  const phaseLabel = {
    jira:'JIRA Backlog Scan',repo:'Repository Browser',debt:'Debt Detection',
    cost:'Cost & ROI Analysis',nego:'Negotiation Agent',dashboard:'Final Dashboard',
  }[phase];

  return (
    <div className="shell">
      <div className="topbar">
        <div className="logo">
          <div className="logo-mark">TD</div>
          <div className="logo-text">Tech Debt <span>Negotiator</span></div>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          {selectedJira && <span className="badge badge-info">{selectedJira.key}</span>}
          {costData && <span className="badge badge-warn">{fmt(costData.annual_savings)}/YR DEBT</span>}
          {negotiation && <span className="badge badge-live">ANALYSIS COMPLETE</span>}
        </div>
      </div>

      <Stepper phase={phase}/>

      <div className="body-layout">
        <div className="main-area">
          {phase==='jira' && <PhaseJira onSelect={selectJira} selectedItem={selectedJira} logs={logs} running={jiraLoading} onLoad={loadJira} activeProduct={activeProduct} onProductChange={onProductChange} jiraItems={activeJiraItems} project={activeProject}/>}
          {phase==='repo' && <PhaseRepo selectedJira={selectedJira} repoName={selectedJira?.repo} repoData={activeRepoData} onScan={scanRepo} scanning={scanning} scanned={scanned}/>}
          {phase==='debt' && <PhaseDebt debts={activeDebts} selected={selectedDebts} onToggle={toggleDebt} onCalc={calcCost} calculating={calculating} costData={costData}/>}
          {phase==='cost' && <PhaseCost costData={costData} selectedDebts={selectedDebts} allDebts={activeDebts} onNegotiate={runNegotiation} negotiating={negotiating} negotiation={negotiation}/>}
          {phase==='nego' && <PhaseNego negotiation={negotiation} costData={costData} nego={product.nego} jiraCount={activeJiraItems.length} onDashboard={()=>setPhase('dashboard')}/>}
          {phase==='dashboard' && <PhaseDashboard costData={costData} negotiation={negotiation} selectedDebts={selectedDebts} allDebts={ALL_DEBTS} nego={product.nego} jiraItems={activeJiraItems}/>}
        </div>

        <LogPanel logs={logs}/>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
